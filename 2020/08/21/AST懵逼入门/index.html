<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="ASTæ‡µé€¼å…¥é—¨"/>




  <meta name="keywords" content="AST, Fynn's Blog" />










  <link rel="alternate" href="/atom.xml" title="Fynn's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://fynn90.github.io/2020/08/21/ASTæ‡µé€¼å…¥é—¨/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?607980a031d3edcefed502ce80e77ffb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-115728733-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "jH321kB4p1r5FNrL8YBCwbrG-gzGzoHsz",
      appKey: "Q8vnaBtTzmVPbVX8tdzM7z7w"
    });
  </script>





    <title> ASTæ‡µé€¼å…¥é—¨ - Fynn's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Fynn's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            é¦–é¡µ
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            å½’æ¡£
          
        </li>
      </a>
    
      <a href="/categories/">
        <li class="mobile-menu-item">
          
          
            åˆ†ç±»
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Fynn's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              é¦–é¡µ
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              å½’æ¡£
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            
            
              åˆ†ç±»
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          ASTæ‡µé€¼å…¥é—¨
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-08-21
        </span>
        
          <div class="post-category">
            
              <a href="/categories/AST/">AST</a>
            
          </div>
        
        
        <div class="post-visits"
             data-url="/2020/08/21/ASTæ‡µé€¼å…¥é—¨/"
             data-title="ASTæ‡µé€¼å…¥é—¨">
            é˜…è¯»æ¬¡æ•°
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-èƒ½åšä»€ä¹ˆ"><span class="toc-text">AST èƒ½åšä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-JavaScript"><span class="toc-text">AST-JavaScript</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è¯­æ³•å•å…ƒ"><span class="toc-text">è¯­æ³•å•å…ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§"><span class="toc-text">javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¯­æ³•åˆ†æ"><span class="toc-text">è¯­æ³•åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recast-æ“ä½œASTç‘å£«å†›åˆ€"><span class="toc-text">recast - æ“ä½œASTç‘å£«å†›åˆ€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-type-builders"><span class="toc-text">recast.type.builders</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recast-é«˜çº§ç”¨æ³•"><span class="toc-text">recast é«˜çº§ç”¨æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-run"><span class="toc-text">recast.run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-visit"><span class="toc-text">recast.visit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-types-namedTypes"><span class="toc-text">recast.types.namedTypes</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Babel-ä½¿ç”¨çš„AST-å·¥å…·åº“"><span class="toc-text">Babel ä½¿ç”¨çš„AST å·¥å…·åº“</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babelæ’ä»¶çš„ä½¿ç”¨"><span class="toc-text">babelæ’ä»¶çš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babelè§£æAST"><span class="toc-text">babelè§£æAST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä¾‹å­ğŸŒ°"><span class="toc-text">ä¾‹å­ğŸŒ°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é«˜çº§ç‚¹ä¾‹å­ğŸŒ°"><span class="toc-text">é«˜çº§ç‚¹ä¾‹å­ğŸŒ°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹"><span class="toc-text">Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¬¬ä¸€æ­¥-è§£æ-Parse"><span class="toc-text">ç¬¬ä¸€æ­¥ è§£æ(Parse)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¬¬äºŒæ­¥-ä¼˜åŒ–è¯­æ³•æ ‘-Optimize"><span class="toc-text">ç¬¬äºŒæ­¥ ä¼˜åŒ–è¯­æ³•æ ‘(Optimize)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¬¬ä¸‰æ­¥-ç”Ÿæˆä»£ç -generate"><span class="toc-text">ç¬¬ä¸‰æ­¥ ç”Ÿæˆä»£ç (generate)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASTå¯¹è±¡æ–‡æ¡£"><span class="toc-text">ASTå¯¹è±¡æ–‡æ¡£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒ"><span class="toc-text">å‚è€ƒ</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p><a href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9" target="_blank" rel="noopener">AST(Abstract Syntax Tree)</a>æŠ½è±¡è¯­æ³•æ ‘,æˆ–ç®€ç§°è¯­æ³•æ ‘(Syntax tree). æ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤º. å®ƒä»¥<strong>æ ‘çŠ¶</strong>çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„, æ ‘ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> b â‰  <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> a &gt; b</span><br><span class="line">  a := a âˆ’ b</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  b := b âˆ’ a</span><br><span class="line"><span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>
<p><img src="https://pic.downk.cc/item/5fc5afa9d590d4788a8bfa5b.png" alt=""></p>
<p>ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯â€œæŠ½è±¡â€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚æ¯”å¦‚ï¼ŒåµŒå¥—æ‹¬å·è¢«éšå«åœ¨æ ‘çš„ç»“æ„ä¸­ï¼Œå¹¶æ²¡æœ‰ä»¥èŠ‚ç‚¹çš„å½¢å¼å‘ˆç°ï¼›è€Œç±»ä¼¼äº <code>if-condition-then</code> è¿™æ ·çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ä¸‰ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹æ¥è¡¨ç¤ºã€‚</p>
<p>å’ŒæŠ½è±¡è¯­æ³•æ ‘ç›¸å¯¹çš„æ˜¯å…·ä½“è¯­æ³•æ ‘ï¼ˆé€šå¸¸ç§°ä½œ<a href="https://zh.wikipedia.org/wiki/åˆ†ææ ‘" target="_blank" rel="noopener">åˆ†ææ ‘</a>ï¼‰ã€‚ä¸€èˆ¬çš„ï¼Œåœ¨æºä»£ç çš„ç¿»è¯‘å’Œ<a href="https://zh.wikipedia.org/wiki/ç¼–è¯‘" target="_blank" rel="noopener">ç¼–è¯‘</a>è¿‡ç¨‹ä¸­ï¼Œ<a href="https://zh.wikipedia.org/wiki/èªæ³•åˆ†æå™¨" target="_blank" rel="noopener">è¯­æ³•åˆ†æå™¨</a>åˆ›å»ºå‡ºåˆ†ææ ‘ï¼Œç„¶åä»åˆ†ææ ‘ç”ŸæˆASTã€‚ä¸€æ—¦ASTè¢«åˆ›å»ºå‡ºæ¥ï¼Œåœ¨åç»­çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚<a href="https://zh.wikipedia.org/wiki/è¯­ä¹‰åˆ†æ" target="_blank" rel="noopener">è¯­ä¹‰åˆ†æ</a>é˜¶æ®µï¼Œä¼šæ·»åŠ ä¸€äº›ä¿¡æ¯ã€‚</p>
<h2 id="AST-èƒ½åšä»€ä¹ˆ"><a href="#AST-èƒ½åšä»€ä¹ˆ" class="headerlink" title="AST èƒ½åšä»€ä¹ˆ"></a>AST èƒ½åšä»€ä¹ˆ</h2><ul>
<li>è¯­æ³•æ£€æŸ¥ã€ä»£ç é£æ ¼æ£€æŸ¥ã€æ ¼å¼åŒ–ä»£ç ã€è¯­æ³•é«˜äº®ã€é”™è¯¯æç¤ºã€è‡ªåŠ¨è¡¥å…¨ç­‰. </li>
<li>ä»£ç æ··æ·†å‹ç¼©.</li>
<li>ä¼˜åŒ–å˜æ›´ä»£ç ,æ”¹å˜ä»£ç ç»“æ„ç­‰.</li>
</ul>
<h2 id="AST-JavaScript"><a href="#AST-JavaScript" class="headerlink" title="AST-JavaScript"></a>AST-JavaScript</h2><p>javascript parser æŠŠJSä»£ç è½¬æ¢æˆ æŠ½è±¡è¯­æ³•æ ‘çš„è§£æå™¨.æµè§ˆå™¨åœ¨æ‰§è¡ŒJSä¹‹å‰ä¼šæŠŠæºç é€šè¿‡è§£æå™¨è½¬åŒ–æˆæŠ½è±¡è¯­æ³•æ ‘,å†è¿›ä¸€æ­¥è½¬æ¢æˆå­—èŠ‚ç ç”šè‡³æœºå™¨ç .</p>
<p>å¸¸ç”¨çš„javascript parseræœ‰:</p>
<ul>
<li><a href="https://github.com/jquery/esprima" target="_blank" rel="noopener">Esprima</a></li>
<li><a href="https://github.com/mishoo/UglifyJS2" target="_blank" rel="noopener">UglifyJS2</a></li>
<li><a href="https://github.com/google/traceur-compiler" target="_blank" rel="noopener">Traceur</a></li>
<li><a href="https://github.com/acornjs/acorn" target="_blank" rel="noopener">Acorn</a></li>
<li><a href="https://github.com/eslint/espree" target="_blank" rel="noopener">Espree</a></li>
<li><a href="https://github.com/shapesecurity/shift-parser-js" target="_blank" rel="noopener">Shfit</a></li>
</ul>
<p>åœ¨æ•´ä¸ªè§£æè¿‡ç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†:</p>
<ul>
<li>åˆ†è¯: å°†æ•´ä¸ªä»£ç å­—ç¬¦ä¸²åˆ†å‰²æˆæœ€å°<strong>è¯­æ³•å•å…ƒ</strong>æ•°ç»„</li>
<li>è¯­æ³•åˆ†æ: åœ¨åˆ†è¯åŸºç¡€ä¸Šå»ºç«‹åˆ†æè¯­æ³•å•å…ƒä¹‹é—´çš„å…³ç³»</li>
</ul>
<h3 id="è¯­æ³•å•å…ƒ"><a href="#è¯­æ³•å•å…ƒ" class="headerlink" title="è¯­æ³•å•å…ƒ"></a>è¯­æ³•å•å…ƒ</h3><p>è¯­æ³•å•å…ƒ:è¢«è§£æè¯­æ³•ä¸­å…·å¤‡å®é™…æ„ä¹‰çš„æœ€å°å•å…ƒ. </p>
<p>ä¾‹å¦‚:â€œ2019å¹´æ˜¯ç¥–å›½70å‘¨å¹´â€. è¿™å¥è¯æ‹†æˆæœ€å°å•å…ƒæ˜¯: â€œ2019å¹´â€,â€œæ˜¯â€,â€œç¥–å›½â€,â€œ70â€,â€œå‘¨å¹´â€. è¿™äº›è¯­æ³•å•å…ƒå†è¿›è¡Œæ‹†åˆ†å°±å¤±å»äº†å®ƒæœ¬æ¥è¦è¡¨è¾¾çš„æ„æ€.</p>
<h4 id="javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§"><a href="#javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§" class="headerlink" title="javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§:"></a>javascriptä»£ç ä¸­çš„è¯­æ³•å•å…ƒä¸»è¦åŒ…å«ä¸€ä¸‹å‡ ç§:</h4><ul>
<li>å…³é”®å­—: <code>let</code>,<code>const</code>,<code>var</code></li>
<li>æ ‡è¯†ç¬¦: æ²¡æœ‰è¢«æ‹¬å·å¼•èµ·çš„è¿ç»­å­—ç¬¦ä¸²,å¯èƒ½æ˜¯å˜é‡,ä¹Ÿå¯èƒ½æ˜¯<code>if</code>,<code>else</code>è¿™äº›å…³é”®å­—</li>
<li>æ•°å­—è¿ç®—ç¬¦: <code>+</code>ã€<code>-</code>ã€<code>*</code>ã€<code>%</code></li>
<li>æ•°å­—: åå…­è¿›åˆ¶ã€åè¿›åˆ¶ã€å…«è¿›åˆ¶ç­‰ä»¥åŠç§‘å­¦è¡¨è¾¾å¼ç­‰è¯­æ³•</li>
<li>ç©ºæ ¼: è¿ç»­çš„ç©ºæ ¼ã€æ¢è¡Œã€åˆ¶è¡¨ç¬¦ç­‰</li>
<li>æ³¨é‡Š: è¡Œæ³¨é‡Šå’Œå¤§å—çš„å—æ³¨é‡Šä½œä¸ºæœ€å°çš„è¯­æ³•å•å…ƒ</li>
<li>å…¶ä»–: å¤§æ‹¬å·,å°æ‹¬å·,åˆ†å·,å†’å·ç­‰.</li>
</ul>
<p><strong>ä¾‹å­ğŸŒ°:</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>+<span class="number">2</span>)*<span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åˆ†è¯,æˆ‘ä»¬å¾—åˆ°ä¸€ä¸‹å†…å®¹:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Punctuator"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"("</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Numeric"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Punctuator"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"+"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Numeric"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"2"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Punctuator"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">")"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Punctuator"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Numeric"</span>,</span><br><span class="line">        <span class="string">"value"</span>: <span class="string">"3"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>åœ¨çº¿åˆ†è¯å·¥å…·:<a href="https://esprima.org/demo/parse.html#" target="_blank" rel="noopener">esprima/parser</a></p>
<h3 id="è¯­æ³•åˆ†æ"><a href="#è¯­æ³•åˆ†æ" class="headerlink" title="è¯­æ³•åˆ†æ"></a>è¯­æ³•åˆ†æ</h3><p>åˆ†è¯åå¾—åˆ°ä¸€ä¸ªä¸ªç‹¬ç«‹çš„è¯­æ³•å•å…ƒ, è¿™äº›è¯­æ³•å•å…ƒéœ€è¦å»ºç«‹å…¶å®é™…çš„å…³ç³»æ‰æœ‰æ„ä¹‰. å»ºç«‹è¯­æ³•å•å…ƒçš„è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯è¯­æ³•åˆ†æ,è¿™ä¸ªä¸€èˆ¬æ˜¯é€’å½’è¿‡ç¨‹.</p>
<p><code>(1+2)*3;</code> æœ€åçš„è¯­æ³•åˆ†æç»“æœæ˜¯:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"Program"</span>,</span><br><span class="line">  <span class="attr">"start"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"end"</span>: <span class="number">186</span>,</span><br><span class="line">  <span class="attr">"body"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"ExpressionStatement"</span>,</span><br><span class="line">      <span class="attr">"start"</span>: <span class="number">178</span>,</span><br><span class="line">      <span class="attr">"end"</span>: <span class="number">186</span>,</span><br><span class="line">      <span class="attr">"expression"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"BinaryExpression"</span>,</span><br><span class="line">        <span class="attr">"start"</span>: <span class="number">178</span>,</span><br><span class="line">        <span class="attr">"end"</span>: <span class="number">185</span>,</span><br><span class="line">        <span class="attr">"left"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"BinaryExpression"</span>,</span><br><span class="line">          <span class="attr">"start"</span>: <span class="number">179</span>,</span><br><span class="line">          <span class="attr">"end"</span>: <span class="number">182</span>,</span><br><span class="line">          <span class="attr">"left"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</span><br><span class="line">            <span class="attr">"start"</span>: <span class="number">179</span>,</span><br><span class="line">            <span class="attr">"end"</span>: <span class="number">180</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"raw"</span>: <span class="string">"1"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"operator"</span>: <span class="string">"+"</span>,</span><br><span class="line">          <span class="attr">"right"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</span><br><span class="line">            <span class="attr">"start"</span>: <span class="number">181</span>,</span><br><span class="line">            <span class="attr">"end"</span>: <span class="number">182</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"raw"</span>: <span class="string">"2"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"operator"</span>: <span class="string">"*"</span>,</span><br><span class="line">        <span class="attr">"right"</span>: &#123;</span><br><span class="line">          <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</span><br><span class="line">          <span class="attr">"start"</span>: <span class="number">184</span>,</span><br><span class="line">          <span class="attr">"end"</span>: <span class="number">185</span>,</span><br><span class="line">          <span class="attr">"value"</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">"raw"</span>: <span class="string">"3"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"sourceType"</span>: <span class="string">"module"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://astexplorer.net/" target="_blank" rel="noopener">astexplorer</a> åœ¨çº¿å¯è§†åŒ– ASTå·¥å…·.</p>
<p><code>body</code>è¡¨ç¤ºç¨‹åºä½“ï¼Œè€Œç¨‹åºä½“ä¸­åŒ…å«äº†ä¸€åˆ™è¡¨è¾¾å¼<code>ExpressionStatement</code>, è¡¨è¾¾å¼ä½“é‡ŒåŒ…å«äº†æ“ä½œç¬¦ <code>*</code>,ä»¥åŠå·¦å³ä¸¤è¾¹è¡¨è¾¾å¼ï¼Œå…¶ä¸­å³è¾¹æ˜¯æ•°å­—<code>3</code>,è€Œå·¦è¾¹è¡¨è¾¾å¼è¿˜åŒ…å«ä¸€å±‚è¡¨è¾¾å¼ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ª<code>+</code> æ“ä½œç¬¦ï¼Œä»¥åŠå·¦å³ä¸¤è¾¹åˆ†åˆ«ä¸º<code>1</code>å’Œ<code>2</code>çš„æ•°å­—ã€‚</p>
<p><img src="https://pic.downk.cc/item/5fc9a248394ac52378d2f52e.png" alt=""></p>
<h3 id="recast-æ“ä½œASTç‘å£«å†›åˆ€"><a href="#recast-æ“ä½œASTç‘å£«å†›åˆ€" class="headerlink" title="recast - æ“ä½œASTç‘å£«å†›åˆ€"></a>recast - æ“ä½œASTç‘å£«å†›åˆ€</h3><p><code>recast</code>å¯ä»¥å°† JSä»£ç å—è§£ææˆ AST,å¹¶é’ˆå¯¹ASTè¿›è¡ŒJSä»£ç çš„ä¿®æ”¹.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">'recast'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">  function add(a,b) &#123;</span></span><br><span class="line"><span class="string">    return a+b;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = recast.parse(code);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> add = ast.program.body[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(add)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">FunctionDeclaration &#123;</span></span><br><span class="line"><span class="comment">  type: 'FunctionDeclaration',</span></span><br><span class="line"><span class="comment">  id: Identifier &#123;</span></span><br><span class="line"><span class="comment">    type: 'Identifier',</span></span><br><span class="line"><span class="comment">    name: 'add',</span></span><br><span class="line"><span class="comment">    loc: &#123;</span></span><br><span class="line"><span class="comment">      start: [Object],</span></span><br><span class="line"><span class="comment">      end: [Object],</span></span><br><span class="line"><span class="comment">      lines: [Lines],</span></span><br><span class="line"><span class="comment">      tokens: [Array],</span></span><br><span class="line"><span class="comment">      indent: 2</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  params: [</span></span><br><span class="line"><span class="comment">    Identifier &#123; type: 'Identifier', name: 'a', loc: [Object] &#125;,</span></span><br><span class="line"><span class="comment">    Identifier &#123; type: 'Identifier', name: 'b', loc: [Object] &#125;</span></span><br><span class="line"><span class="comment">  ],</span></span><br><span class="line"><span class="comment">  body: BlockStatement &#123;</span></span><br><span class="line"><span class="comment">    type: 'BlockStatement',</span></span><br><span class="line"><span class="comment">    body: [ [ReturnStatement] ],</span></span><br><span class="line"><span class="comment">    loc: &#123;</span></span><br><span class="line"><span class="comment">      start: [Object],</span></span><br><span class="line"><span class="comment">      end: [Object],</span></span><br><span class="line"><span class="comment">      lines: [Lines],</span></span><br><span class="line"><span class="comment">      tokens: [Array],</span></span><br><span class="line"><span class="comment">      indent: 2</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  generator: false,</span></span><br><span class="line"><span class="comment">  expression: false,</span></span><br><span class="line"><span class="comment">  async: false,</span></span><br><span class="line"><span class="comment">  loc: &#123;</span></span><br><span class="line"><span class="comment">    start: &#123; line: 2, column: 2, token: 0 &#125;,</span></span><br><span class="line"><span class="comment">    end: &#123; line: 4, column: 3, token: 14 &#125;,</span></span><br><span class="line"><span class="comment">    lines: Lines &#123;</span></span><br><span class="line"><span class="comment">      infos: [Array],</span></span><br><span class="line"><span class="comment">      mappings: [],</span></span><br><span class="line"><span class="comment">      cachedSourceMap: null,</span></span><br><span class="line"><span class="comment">      cachedTabWidth: undefined,</span></span><br><span class="line"><span class="comment">      length: 5,</span></span><br><span class="line"><span class="comment">      name: null</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    tokens: [</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object]</span></span><br><span class="line"><span class="comment">    ],</span></span><br><span class="line"><span class="comment">    indent: 2</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(add.params[<span class="number">0</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Identifier &#123;</span></span><br><span class="line"><span class="comment">  type: 'Identifier',</span></span><br><span class="line"><span class="comment">  name: 'a',</span></span><br><span class="line"><span class="comment">  loc: &#123;</span></span><br><span class="line"><span class="comment">    start: &#123; line: 2, column: 15, token: 3 &#125;,</span></span><br><span class="line"><span class="comment">    end: &#123; line: 2, column: 16, token: 4 &#125;,</span></span><br><span class="line"><span class="comment">    lines: Lines &#123;</span></span><br><span class="line"><span class="comment">      infos: [Array],</span></span><br><span class="line"><span class="comment">      mappings: [],</span></span><br><span class="line"><span class="comment">      cachedSourceMap: null,</span></span><br><span class="line"><span class="comment">      cachedTabWidth: undefined,</span></span><br><span class="line"><span class="comment">      length: 5,</span></span><br><span class="line"><span class="comment">      name: null</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    tokens: [</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object]</span></span><br><span class="line"><span class="comment">    ],</span></span><br><span class="line"><span class="comment">    indent: 2</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="recast-type-builders"><a href="#recast-type-builders" class="headerlink" title="recast.type.builders"></a>recast.type.builders</h4><p><code>recast.type.builders</code>æä¾›å„ç§å·¥å…·ç”¨äºASTç»“æ„çš„ç»„è£…,ä»¥å¸®åŠ©å¯¹äºASTç»“æ„ä¿®æ”¹.</p>
<p>å®šä¸€ä¸ªå°å°çš„ç›®æ ‡:</p>
<p><code>function add(a,b) {}</code>æ”¹æˆåŒ¿åå‡½æ•°å¼å£°æ˜<code>const add = function (a,b) {...}</code></p>
<p>æ­¥éª¤:</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ª<code>VariableDeclaration</code>å˜é‡å£°æ˜å¯¹è±¡, å£°æ˜å¤´ä¸º<code>const</code>, å†…å®¹ä¸ºä¸€ä¸ªå³å°†åˆ›å»ºçš„<code>VariableDeclarator</code>å¯¹è±¡.</li>
<li>åˆ›å»ºä¸€ä¸ª<code>VariableDeclarator</code>,æ”¾ç½®<code>add.id</code>åœ¨å·¦è¾¹,å³è¾¹æ˜¯å°†åˆ›å»ºçš„<code>FunctionDeclaration</code>å¯¹è±¡</li>
<li>åˆ›å»ºä¸€ä¸ª<code>FunctionDeclaration</code>,åŒ…å«å‰é¢å‰æ‰€è¿°çš„ä¸‰ä¸ªç»„ä»¶<code>id</code>,<code>params</code>,<code>body</code>. å› ä¸ºæ˜¯åŒ¿åå‡½æ•°åˆ™idè®¾ä¸ºç©º,<code>params</code>ä½¿ç”¨<code>add.params</code>,<code>body</code>ä½¿ç”¨<code>add.body</code>.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">'recast'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">  function add(a,b) &#123;</span></span><br><span class="line"><span class="string">    return a+b;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = recast.parse(code);</span><br><span class="line"><span class="keyword">const</span> add = ast.program.body[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å…¥å˜é‡å£°æ˜ï¼Œå˜é‡ç¬¦å·ï¼Œå‡½æ•°å£°æ˜ä¸‰ç§â€œæ¨¡å…·â€</span></span><br><span class="line"><span class="keyword">const</span> &#123;variableDeclaration, variableDeclarator, functionExpression&#125; = recast.types.builders</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å‡†å¤‡å¥½çš„ç»„ä»¶ç½®å…¥æ¨¡å…·ï¼Œå¹¶ç»„è£…å›åŸæ¥çš„astå¯¹è±¡ã€‚</span></span><br><span class="line">ast.program.body[<span class="number">0</span>] = variableDeclaration(<span class="string">"const"</span>, [</span><br><span class="line">  variableDeclarator(add.id, functionExpression(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// Anonymize the function expression.</span></span><br><span class="line">    add.params,</span><br><span class="line">    add.body</span><br><span class="line">  ))</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†ASTå¯¹è±¡é‡æ–°è½¬å›å¯ä»¥é˜…è¯»çš„ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> output = recast.print(ast).code;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  const add = function(a, b) &#123;</span></span><br><span class="line"><span class="comment">    return a+b;</span></span><br><span class="line"><span class="comment">  &#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="recast-é«˜çº§ç”¨æ³•"><a href="#recast-é«˜çº§ç”¨æ³•" class="headerlink" title="recast é«˜çº§ç”¨æ³•"></a>recast é«˜çº§ç”¨æ³•</h3><p>é™¤äº†<code>parse/print/builder</code>,Recasetçš„ä¸‰é¡¹ä¸»è¦åŠŸèƒ½:</p>
<ul>
<li><code>recast.run</code>: é€šè¿‡å‘½ä»¤è¡Œè¯»å–jsæ–‡ä»¶, å¹¶è½¬åŒ–æˆASTä»¥ä¾›å¤„ç†.</li>
<li><code>recast.types.namedTypes</code>: é€šè¿‡<code>assert()</code>å’Œ<code>check()</code>,å¯ä»¥éªŒè¯ASTå¯¹è±¡çš„ç±»å‹.</li>
<li><code>recast.visit</code>: éå†ASTæ ‘, è·å–æœ‰æ•ˆçš„ASTå¯¹è±¡å¹¶è¿›è¡Œæ›´æ”¹.</li>
</ul>
<h4 id="recast-run"><a href="#recast-run" class="headerlink" title="recast.run"></a><code>recast.run</code></h4><p>demo.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonDivision</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (b !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">      a = sub(a, b)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      b = sub(b, a)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>read.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">'recast'</span>)</span><br><span class="line">recast.run( <span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>)</span>&#123;</span><br><span class="line">    printSource(ast)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤è¡Œè¾“å…¥:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">node <span class="built_in">read</span> demo.js</span><br><span class="line"></span><br><span class="line">// <span class="keyword">function</span> add(a, b) &#123;</span><br><span class="line">//  <span class="built_in">return</span> a + b</span><br><span class="line">//&#125;</span><br><span class="line">//</span><br><span class="line">//<span class="keyword">function</span> sub(a, b) &#123;</span><br><span class="line">//  <span class="built_in">return</span> a - b</span><br><span class="line">//&#125;</span><br><span class="line">//</span><br><span class="line">//<span class="keyword">function</span> commonDivision(a, b) &#123;</span><br><span class="line">//  <span class="keyword">while</span> (b !== 0) &#123;</span><br><span class="line">//    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">//      a = sub(a, b)</span><br><span class="line">//    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">//      b = sub(b, a)</span><br><span class="line">//    &#125;</span><br><span class="line">//  &#125;</span><br><span class="line">//  <span class="built_in">return</span> a</span><br><span class="line">//&#125;%</span><br></pre></td></tr></table></figure>
<p><code>recast.run</code>è¯»å–demo.jsæ–‡ä»¶,å¹¶å°†å†…å®¹è½¬æˆäº†ASTå¯¹è±¡.</p>
<p>åŒæ—¶å®ƒè¿˜æä¾›äº†ä¸€ä¸ª<code>printSource</code>å‡½æ•°ï¼Œéšæ—¶å¯ä»¥å°†astçš„å†…å®¹è½¬æ¢å›æºç ï¼Œä»¥æ–¹ä¾¿è°ƒè¯•ã€‚</p>
<h4 id="recast-visit"><a href="#recast-visit" class="headerlink" title="recast.visit"></a><code>recast.visit</code></h4><p>visit.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast  = <span class="built_in">require</span>(<span class="string">'recast'</span>)</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      visitExpressionStatement: <span class="function"><span class="keyword">function</span>(<span class="params">&#123;node&#125;</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(node)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>recast.visitå°†ASTå¯¹è±¡å†…çš„èŠ‚ç‚¹è¿›è¡Œé€ä¸ªéå†</p>
<p><strong>æ³¨æ„:</strong></p>
<ol>
<li>ä½ æƒ³æ“ä½œå‡½æ•°å£°æ˜,å°±ä½¿ç”¨<code>visitFunctionDelaration</code>éå†,æƒ³æ“ä½œèµ‹å€¼è¡¨è¾¾å¼,å°±ä½¿ç”¨<code>visitExpressionStatement</code>.åªè¦åœ¨<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects" target="_blank" rel="noopener">ASTå¯¹è±¡æ–‡æ¡£</a>ä¸­çš„å®šä¹‰å¯¹è±¡,åœ¨å‰é¢å¢åŠ <code>visit</code>å°±å¯éå†</li>
<li>é€šè¿‡<code>node</code>å¯ä»¥å–åˆ°ASTå¯¹è±¡</li>
<li>æ¯ä¸ªéå†å‡½æ•°åå¿…é¡»åŠ ä¸Šreturn falseï¼Œæˆ–è€…é€‰æ‹©ä»¥ä¸‹å†™æ³•ï¼Œå¦åˆ™æŠ¥é”™ï¼š</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast  = <span class="built_in">require</span>(<span class="string">'recast'</span>)</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      visitExpressionStatement: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.node</span><br><span class="line">        printSource(node)</span><br><span class="line">        <span class="keyword">this</span>.traverse(path)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="recast-types-namedTypes"><a href="#recast-types-namedTypes" class="headerlink" title="recast.types.namedTypes"></a><code>recast.types.namedTypes</code></h4><p><code>recast.types.namedTypes</code>ç®€ç§°<code>TNT</code>,å®ƒç”¨æ¥åˆ¤æ–­ASTå¯¹è±¡æ˜¯å¦ä¸ºæŒ‡å®šçš„ç±»å‹.</p>
<p><code>TNT.Node.assert()</code>åˆ¤æ–­<code>Node</code>æ˜¯å¦è§„èŒƒ,å¦‚æœä¸ç¬¦åˆè§„èŒƒåˆ™æŠ¥é”™é€€å‡º</p>
<p><code>TNT.Node.check()</code>å¯ä»¥åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸€è‡´,å¹¶è¾“å‡º<code>False</code>å’Œ<code>True</code></p>
<p><strong>æ³¨æ„:</strong> ä¸Šè¿°Nodeå¯ä»¥æ›¿æ¢æˆä»»æ„ASTå¯¹è±¡ï¼Œä¾‹å¦‚TNT.ExpressionStatement.check(),TNT.FunctionDeclaration.assert()</p>
<p>check.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">"recast"</span>);</span><br><span class="line"><span class="keyword">const</span> TNT = recast.types.namedTypes</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      visitExpressionStatement: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.value</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºExpressionStatementï¼Œæ­£ç¡®åˆ™è¾“å‡ºä¸€è¡Œå­—ã€‚</span></span><br><span class="line">        <span class="keyword">if</span>(TNT.ExpressionStatement.check(node))&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'è¿™æ˜¯ä¸€ä¸ªExpressionStatement'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.traverse(path);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>assert.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">"recast"</span>);</span><br><span class="line"><span class="keyword">const</span> TNT = recast.types.namedTypes</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      visitExpressionStatement: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.node</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºExpressionStatementï¼Œæ­£ç¡®ä¸è¾“å‡ºï¼Œé”™è¯¯åˆ™å…¨å±€æŠ¥é”™</span></span><br><span class="line">        TNT.ExpressionStatement.assert(node)</span><br><span class="line">        <span class="keyword">this</span>.traverse(path);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Babel-ä½¿ç”¨çš„AST-å·¥å…·åº“"><a href="#Babel-ä½¿ç”¨çš„AST-å·¥å…·åº“" class="headerlink" title="Babel ä½¿ç”¨çš„AST å·¥å…·åº“"></a>Babel ä½¿ç”¨çš„AST å·¥å…·åº“</h2><p>babel å°±å‡ºç°äº†ï¼Œå®ƒä¸»è¦è§£å†³äº†å°±æ˜¯ä¸€äº›æµè§ˆå™¨ä¸å…¼å®¹ Es6 æ–°ç‰¹æ€§çš„é—®é¢˜ï¼Œå…¶å®å°±æŠŠ Es6 ä»£ç è½¬æ¢ä¸º Es5 çš„ä»£ç ï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼Œbabel è½¬æ¢ä»£ç å…¶å®å°±æ˜¯ç”¨äº† ASTï¼Œbabel ä¸ AST å°±æœ‰ç€å¾ˆä¸€ç§ç‰¹åˆ«çš„å…³ç³»ã€‚</p>
<p>å½“æˆ‘ä»¬é…ç½® babel çš„æ—¶å€™ï¼Œä¸ç®¡æ˜¯åœ¨ <code>.babelrc</code> æˆ–è€… <code>babel.config.js</code> æ–‡ä»¶é‡Œé¢é…ç½®çš„éƒ½æœ‰ <code>presets</code> å’Œ <code>plugins</code> ä¸¤ä¸ªé…ç½®é¡¹:</p>
<p>æ’ä»¶å’Œé¢„è®¾çš„åŒºåˆ«</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// .babelrc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [<span class="string">"@babel/preset-env"</span>],</span><br><span class="line">  <span class="attr">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬é…ç½®äº† <code>presets</code> ä¸­æœ‰ <code>@babel/preset-env</code>ï¼Œé‚£ä¹ˆ <code>@babel/core</code> å°±ä¼šå»æ‰¾ <code>preset-env</code> é¢„è®¾çš„æ’ä»¶åŒ…ï¼Œå®ƒæ˜¯ä¸€å¥—</p>
<p>babel æ ¸å¿ƒåŒ…å¹¶ä¸ä¼šå»è½¬æ¢ä»£ç ï¼Œæ ¸å¿ƒåŒ…åªæä¾›ä¸€äº›æ ¸å¿ƒ APIï¼ŒçœŸæ­£çš„ä»£ç è½¬æ¢å·¥ä½œç”±æ’ä»¶æˆ–è€…é¢„è®¾æ¥å®Œæˆï¼Œæ¯”å¦‚è¦è½¬æ¢ç®­å¤´å‡½æ•°ï¼Œä¼šç”¨åˆ°è¿™ä¸ª pluginï¼Œ<code>@babel/plugin-transform-arrow-functions</code>ï¼Œå½“éœ€è¦è½¬æ¢çš„è¦æ±‚å¢åŠ æ—¶ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å»ä¸€ä¸€é…ç½®ç›¸åº”çš„ pluginï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨åˆ°é¢„è®¾äº†ï¼Œä¹Ÿå°±æ˜¯ presetsã€‚presets æ˜¯ plugins çš„é›†åˆï¼Œä¸€ä¸ª presets å†…éƒ¨åŒ…å«äº†å¾ˆå¤š pluginã€‚</p>
<h3 id="babelæ’ä»¶çš„ä½¿ç”¨"><a href="#babelæ’ä»¶çš„ä½¿ç”¨" class="headerlink" title="babelæ’ä»¶çš„ä½¿ç”¨"></a>babelæ’ä»¶çš„ä½¿ç”¨</h3><p>ä½¿ç”¨æ’ä»¶é›†åˆ<code>@babel/preset-env</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>)</span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`const fn = (a, b) =&gt; a + b`</span></span><br><span class="line"><span class="comment">// babel æœ‰ transform æ–¹æ³•ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨éå†ï¼Œä½¿ç”¨ç›¸åº”çš„é¢„è®¾æˆ–è€…æ’ä»¶è½¬æ¢ç›¸åº”çš„ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> r = babel.transform(code, &#123;</span><br><span class="line">  presets: [<span class="string">'@babel/preset-env'</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r.code)</span><br><span class="line"><span class="comment">// æ‰“å°ç»“æœå¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// "use strict";</span></span><br><span class="line"><span class="comment">// var fn = function fn() &#123; return a + b; &#125;;</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å•ç‹¬çš„å·®è·<code>@babel/plugin-transform-arrow-functions</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'@babel/core'</span>)</span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`const fn = (a, b) =&gt; a + b`</span></span><br><span class="line"><span class="comment">// babel æœ‰ transform æ–¹æ³•ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨éå†ï¼Œä½¿ç”¨ç›¸åº”çš„é¢„è®¾æˆ–è€…æ’ä»¶è½¬æ¢ç›¸åº”çš„ä»£ç </span></span><br><span class="line"><span class="keyword">const</span> r = babel.transform(code, &#123;</span><br><span class="line">  plugins: [<span class="string">'@babel/plugin-transform-arrow-functions'</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r.code)</span><br><span class="line"><span class="comment">// æ‰“å°ç»“æœå¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// const fn = function () &#123; return a + b; &#125;;</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä»æ‰“å°ç»“æœå‘ç°æ­¤æ—¶å¹¶æ²¡æœ‰è½¬æ¢æˆ‘ä»¬å˜é‡çš„å£°æ˜æ–¹å¼è¿˜æ˜¯ const å£°æ˜ï¼Œåªæ˜¯è½¬æ¢äº†ç®­å¤´å‡½æ•°</p>
<h3 id="babelè§£æAST"><a href="#babelè§£æAST" class="headerlink" title="babelè§£æAST"></a>babelè§£æAST</h3><p><code>babel</code>ä½¿ç”¨çš„ASTå¼•æ“æ˜¯<code>babylon</code>,<code>babylon</code>å¹¶é<code>babel</code>å›¢é˜Ÿè‡ªå·±å¼€å‘,è€Œæ˜¯fork<code>acorn</code>é¡¹ç›®.</p>
<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>babel</code>å¤„ç†ASTå¯¹è±¡,åªéœ€è¦ä½¿ç”¨:</p>
<ul>
<li><code>@babel/parser</code>: å°†jsä»£ç  â€”&gt; ASTå¯¹è±¡</li>
<li><code>@babel/traverse</code>: å¯¹ASTèŠ‚ç‚¹è¿›è¡Œé€’å½’éå†</li>
<li><code>@babel/types</code>: å¯¹å…·ä½“çš„ASTèŠ‚ç‚¹è¿›è¡Œä¿®æ”¹</li>
<li><code>@babel/generator</code>: <code>AST</code>å¯¹è±¡ â€”&gt;æ–°çš„jsä»£ç .</li>
</ul>
<p>babelè§£æè¿‡ç¨‹åˆ†ä¸º3ä¸ªé˜¶æ®µ:</p>
<p><img src="https://pic.downk.cc/item/5fc9fef7394ac52378283bca.png" alt=""></p>
<ul>
<li><p>ç¬¬1æ­¥ è§£æï¼ˆParseï¼‰é€šè¿‡è§£æå™¨babylonå°†ä»£ç è§£ææˆæŠ½è±¡è¯­æ³•æ ‘</p>
</li>
<li><p>ç¬¬2æ­¥ è½¬æ¢ï¼ˆTransFormï¼‰é€šè¿‡babel-traverse pluginå¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œé‡åˆ°éœ€è¦è½¬æ¢çš„ï¼Œå°±ç›´æ¥åœ¨ASTå¯¹è±¡ä¸Šå¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤æ“ä½œï¼Œæ¯”å¦‚é‡åˆ°ç®­å¤´å‡½æ•°ï¼Œå°±è½¬æ¢æˆæ™®é€šå‡½æ•°ï¼Œæœ€åå¾—åˆ°æ–°çš„ASTæ ‘ã€‚</p>
</li>
<li><p>ç¬¬3æ­¥ ç”Ÿæˆï¼ˆGenerateï¼‰é€šè¿‡babel-generatorå°†ASTæ ‘ç”Ÿæˆes5ä»£ç </p>
</li>
</ul>
<h4 id="ä¾‹å­ğŸŒ°"><a href="#ä¾‹å­ğŸŒ°" class="headerlink" title="ä¾‹å­ğŸŒ°"></a>ä¾‹å­ğŸŒ°</h4><p>ç®€å•çš„è·‘ä¸‹ä»£ç </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">"@babel/generator"</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">"@babel/parser"</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">"@babel/traverse"</span>);</span><br><span class="line"><span class="keyword">const</span> types = <span class="built_in">require</span>(<span class="string">"@babel/types"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 1.parse å°†ä»£ç è§£æä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰</span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(code);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2,traverse è½¬æ¢ä»£ç </span></span><br><span class="line">  traverse.default(ast, &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. generator å°† AST è½¬å›æˆä»£ç </span></span><br><span class="line">  <span class="keyword">return</span> generator.default(ast, &#123;&#125;, code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function getData() &#123;</span></span><br><span class="line"><span class="string">  console.log("data")</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> newCode = compile(code)</span><br><span class="line"><span class="built_in">console</span>.log(newCode)</span><br></pre></td></tr></table></figure>
<h4 id="é«˜çº§ç‚¹ä¾‹å­ğŸŒ°"><a href="#é«˜çº§ç‚¹ä¾‹å­ğŸŒ°" class="headerlink" title="é«˜çº§ç‚¹ä¾‹å­ğŸŒ°"></a>é«˜çº§ç‚¹ä¾‹å­ğŸŒ°</h4><p>è‡ªåŠ¨ç»™<code>console.log</code>å¢åŠ å‡½æ•°å</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">"@babel/generator"</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">"@babel/parser"</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">"@babel/traverse"</span>);</span><br><span class="line"><span class="keyword">const</span> types = <span class="built_in">require</span>(<span class="string">"@babel/types"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 1.parse</span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(code);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2,traverse</span></span><br><span class="line">  <span class="keyword">const</span> visitor = &#123;</span><br><span class="line">    CallExpression(path) &#123;</span><br><span class="line">      <span class="comment">// æ‹¿åˆ° callee æ•°æ®</span></span><br><span class="line">      <span class="keyword">const</span> &#123; callee &#125; = path.node;</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯è°ƒç”¨äº† console.log æ–¹æ³•</span></span><br><span class="line">      <span class="comment">// 1. åˆ¤æ–­æ˜¯å¦æ˜¯æˆå‘˜è¡¨è¾¾å¼èŠ‚ç‚¹ï¼Œä¸Šé¢æˆªå›¾æœ‰è¯¦ç»†ä»‹ç»</span></span><br><span class="line">      <span class="comment">// 2. åˆ¤æ–­æ˜¯å¦æ˜¯ console å¯¹è±¡</span></span><br><span class="line">      <span class="comment">// 3. åˆ¤æ–­å¯¹è±¡çš„å±æ€§æ˜¯å¦æ˜¯ log</span></span><br><span class="line">      <span class="keyword">const</span> isConsoleLog =</span><br><span class="line">        types.isMemberExpression(callee) &amp;&amp;</span><br><span class="line">        callee.object.name === <span class="string">"console"</span> &amp;&amp;</span><br><span class="line">        callee.property.name === <span class="string">"log"</span>;</span><br><span class="line">      <span class="keyword">if</span> (isConsoleLog) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ console.log çš„è°ƒç”¨ æ‰¾åˆ°ä¸Šä¸€ä¸ªçˆ¶èŠ‚ç‚¹æ˜¯å‡½æ•°</span></span><br><span class="line">        <span class="keyword">const</span> funcPath = path.findParent(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> p.isFunctionDeclaration();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// å–å‡½æ•°çš„åç§°</span></span><br><span class="line">        <span class="keyword">const</span> funcName = funcPath.node.id.name;</span><br><span class="line">        <span class="comment">// å°†åç§°é€šè¿‡ types æ¥æ”¾åˆ°å‡½æ•°çš„å‚æ•°å‰é¢å»</span></span><br><span class="line">        path.node.arguments.unshift(types.stringLiteral(funcName));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// traverse è½¬æ¢ä»£ç </span></span><br><span class="line">  traverse.default(ast, visitor);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. generator å°† AST è½¬å›æˆä»£ç </span></span><br><span class="line">  <span class="keyword">return</span> generator.default(ast, &#123;&#125;, code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function getData() &#123;</span></span><br><span class="line"><span class="string">  console.log("data")</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> newCode = compile(code)</span><br><span class="line"><span class="built_in">console</span>.log(newCode)</span><br></pre></td></tr></table></figure>
<p><a href="https://www.lagou.com/lgeduarticle/82247.html" target="_blank" rel="noopener">https://www.lagou.com/lgeduarticle/82247.html</a></p>
<p><a href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/" target="_blank" rel="noopener">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/</a></p>
<p><a href="http://caibaojian.com/ast.html" target="_blank" rel="noopener">http://caibaojian.com/ast.html</a></p>
<p><a href="https://juejin.cn/post/6844904035271573511" target="_blank" rel="noopener">https://juejin.cn/post/6844904035271573511</a></p>
<h2 id="Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹"><a href="#Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹"></a>Vueæ¨¡ç‰ˆç¼–è¯‘è¿‡ç¨‹</h2><p>Vueæä¾›äº†2ä¸ªç‰ˆæœ¬,ä¸€ä¸ªæ˜¯Runtime+Compiler,å¦ä¸€ä¸ªæ˜¯Runtime only.</p>
<p>Runtime+Compileræ˜¯åŒ…å«ç¼–è¯‘ä»£ç çš„,ä¼šæŠŠç¼–è¯‘çš„è¿‡ç¨‹æ”¾åˆ°è¿è¡Œæ—¶åš.</p>
<p>Runtime onlyæ˜¯ä¸åŒ…å«ç¼–è¯‘ä»£ç çš„,éœ€è¦å€ŸåŠ©wenpackçš„vue-loaderæŠŠæ¨¡ç‰ˆç¼–è¯‘æˆrenderå‡½æ•°.</p>
<p>æ— è®ºæ˜¯é‚£ä¸ªç‰ˆæœ¬,éƒ½ä¼šæœ‰ä¸€ä¸ªç¯èŠ‚å°†æ¨¡ç‰ˆç¼–è¯‘æˆrenderå‡½æ•°.</p>
<p><img src="https://pic.downk.cc/item/5fca01c1394ac523782be68d.png" alt=""></p>
<h3 id="ç¬¬ä¸€æ­¥-è§£æ-Parse"><a href="#ç¬¬ä¸€æ­¥-è§£æ-Parse" class="headerlink" title="ç¬¬ä¸€æ­¥ è§£æ(Parse)"></a>ç¬¬ä¸€æ­¥ è§£æ(Parse)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ast = parse(template.trim(), options)</span><br></pre></td></tr></table></figure>
<p>å°†æ¨¡æ¿å­—ç¬¦ä¸²è§£æç”Ÿæˆ AST,è¿™é‡Œçš„è§£æå™¨æ˜¯vueè‡ªå·±å®ç°çš„ï¼Œè§£æè¿‡ç¨‹ä¸­ä¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¯¹æ¨¡æ¿é¡ºåºè§£æï¼Œå½“è§£æåˆ°å¼€å§‹æ ‡ç­¾ã€é—­åˆæ ‡ç­¾ã€æ–‡æœ¬çš„æ—¶å€™éƒ½ä¼šæœ‰ç›¸å¯¹åº”çš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼Œæ¥è¾¾åˆ°æ„é€  AST æ ‘çš„ç›®çš„ã€‚</p>
<p>ç”Ÿæˆçš„AST å…ƒç´ èŠ‚ç‚¹æ€»å…±æœ‰ 3 ç§ç±»å‹ï¼Œ1 ä¸ºæ™®é€šå…ƒç´ ï¼Œ 2 ä¸ºè¡¨è¾¾å¼ï¼Œ3ä¸ºçº¯æ–‡æœ¬ã€‚</p>
<p>ä¾‹å­ğŸŒ°</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">:class</span>=<span class="string">"bindCls"</span> <span class="attr">class</span>=<span class="string">"list"</span> <span class="attr">v-if</span>=<span class="string">"isShow"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in data"</span> @<span class="attr">click</span>=<span class="string">"clickItem(index)"</span>&gt;</span>&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ğŸ‘†æ¨¡ç‰ˆè§£ææˆASTå¯¹è±¡å¦‚ä¸‹:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">'type'</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">'tag'</span>: <span class="string">'ul'</span>,</span><br><span class="line">  <span class="string">'attrsList'</span>: [],</span><br><span class="line">  <span class="string">'attrsMap'</span>: &#123;</span><br><span class="line">    <span class="string">':class'</span>: <span class="string">'bindCls'</span>,</span><br><span class="line">    <span class="string">'class'</span>: <span class="string">'list'</span>,</span><br><span class="line">    <span class="string">'v-if'</span>: <span class="string">'isShow'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'if'</span>: <span class="string">'isShow'</span>,</span><br><span class="line">  <span class="string">'ifConditions'</span>: [&#123;</span><br><span class="line">    <span class="string">'exp'</span>: <span class="string">'isShow'</span>,</span><br><span class="line">    <span class="string">'block'</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">'parent'</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">'plain'</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">'staticClass'</span>: <span class="string">'list'</span>,</span><br><span class="line">  <span class="string">'classBinding'</span>: <span class="string">'bindCls'</span>,</span><br><span class="line">  <span class="string">'children'</span>: [&#123;</span><br><span class="line">    <span class="string">'type'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'tag'</span>: <span class="string">'li'</span>,</span><br><span class="line">    <span class="string">'attrsList'</span>: [&#123;</span><br><span class="line">      <span class="string">'name'</span>: <span class="string">'@click'</span>,</span><br><span class="line">      <span class="string">'value'</span>: <span class="string">'clickItem(index)'</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">'attrsMap'</span>: &#123;</span><br><span class="line">      <span class="string">'@click'</span>: <span class="string">'clickItem(index)'</span>,</span><br><span class="line">      <span class="string">'v-for'</span>: <span class="string">'(item,index) in data'</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">'parent'</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">'plain'</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'events'</span>: &#123;</span><br><span class="line">      <span class="string">'click'</span>: &#123;</span><br><span class="line">        <span class="string">'value'</span>: <span class="string">'clickItem(index)'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'hasBindings'</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">'for'</span>: <span class="string">'data'</span>,</span><br><span class="line">    <span class="string">'alias'</span>: <span class="string">'item'</span>,</span><br><span class="line">    <span class="string">'iterator1'</span>: <span class="string">'index'</span>,</span><br><span class="line">    <span class="string">'children'</span>: [</span><br><span class="line">      <span class="string">'type'</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">'expression'</span>: <span class="string">'_s(item)+":"+_s(index)'</span></span><br><span class="line">      <span class="string">'text'</span>: <span class="string">'&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;'</span>,</span><br><span class="line">      <span class="string">'tokens'</span>: [</span><br><span class="line">        &#123;<span class="string">'@binding'</span>:<span class="string">'item'</span>&#125;,</span><br><span class="line">        <span class="string">':'</span>,</span><br><span class="line">        &#123;<span class="string">'@binding'</span>:<span class="string">'index'</span>&#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¬¬äºŒæ­¥-ä¼˜åŒ–è¯­æ³•æ ‘-Optimize"><a href="#ç¬¬äºŒæ­¥-ä¼˜åŒ–è¯­æ³•æ ‘-Optimize" class="headerlink" title="ç¬¬äºŒæ­¥ ä¼˜åŒ–è¯­æ³•æ ‘(Optimize)"></a>ç¬¬äºŒæ­¥ ä¼˜åŒ–è¯­æ³•æ ‘(Optimize)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optimize(ast, options)</span><br></pre></td></tr></table></figure>
<p>Vueæ¨¡ç‰ˆä¸­å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®éƒ½æ˜¯å“åº”å¼çš„,æœ‰å¾ˆå¤šæ•°æ®åœ¨é¦–æ¬¡æ¸²æŸ“åå°±æ°¸è¿œä¸ä¼šæ”¹å˜äº†. é‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®ç”Ÿæˆçš„DOMä¹Ÿä¸ä¼šæ”¹å˜, æˆ‘ä»¬å¯ä»¥åœ¨patchçš„è¿‡ç¨‹è·³è¿‡ä»–ä»¬çš„å¯¹æ¯”.</p>
<p>æ­¤é˜¶æ®µä¼šæ·±åº¦éå†ç”Ÿæˆçš„ASTæ ‘,æ£€æµ‹å®ƒçš„æ¯ä¸€é¢—å­æ ‘æ˜¯ä¸æ˜¯é™æ€èŠ‚ç‚¹,å¦‚æœæ˜¯é™æ€èŠ‚ç‚¹åˆ™å®ƒä»¬ç”ŸæˆDOMæ°¸è¿œä¸ä¼šæ”¹å˜,è¿™å¯¹è¿è¡Œæ—¶å¯¹æ¨¡ç‰ˆçš„æ›´æ–°èµ·åˆ°æå¤§çš„ä¼˜åŒ–ä½œç”¨.</p>
<p>éå†è¿‡ç¨‹ä¸­,ä¼šå¯¹è¿™ä¸ªASTæ ‘ä¸­çš„æ¯ä¸€ä¸ªASTå…ƒç´ èŠ‚ç‚¹æ ‡è®°staticå’ŒstaticRoot(é€’å½’è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰children,ä¸€æ—¦å­èŠ‚ç‚¹æœ‰ä¸æ˜¯staticçš„æƒ…å†µ,åˆ™ä¸ºfalse,å¦åˆ™ä¸ºtrue).</p>
<p> ç»è¿‡è¯¥é˜¶æ®µ,ä¸Šé¢ä¾‹å­ä¸­çš„ASTä¼šå˜æˆ</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">'type'</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">'tag'</span>: <span class="string">'ul'</span>,</span><br><span class="line">  <span class="string">'attrsList'</span>: [],</span><br><span class="line">  <span class="string">'attrsMap'</span>: &#123;</span><br><span class="line">    <span class="string">':class'</span>: <span class="string">'bindCls'</span>,</span><br><span class="line">    <span class="string">'class'</span>: <span class="string">'list'</span>,</span><br><span class="line">    <span class="string">'v-if'</span>: <span class="string">'isShow'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'if'</span>: <span class="string">'isShow'</span>,</span><br><span class="line">  <span class="string">'ifConditions'</span>: [&#123;</span><br><span class="line">    <span class="string">'exp'</span>: <span class="string">'isShow'</span>,</span><br><span class="line">    <span class="string">'block'</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">'parent'</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">'plain'</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">'staticClass'</span>: <span class="string">'list'</span>,</span><br><span class="line">  <span class="string">'classBinding'</span>: <span class="string">'bindCls'</span>,</span><br><span class="line">  <span class="string">'static'</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">'staticRoot'</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">'children'</span>: [&#123;</span><br><span class="line">    <span class="string">'type'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'tag'</span>: <span class="string">'li'</span>,</span><br><span class="line">    <span class="string">'attrsList'</span>: [&#123;</span><br><span class="line">      <span class="string">'name'</span>: <span class="string">'@click'</span>,</span><br><span class="line">      <span class="string">'value'</span>: <span class="string">'clickItem(index)'</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">'attrsMap'</span>: &#123;</span><br><span class="line">      <span class="string">'@click'</span>: <span class="string">'clickItem(index)'</span>,</span><br><span class="line">      <span class="string">'v-for'</span>: <span class="string">'(item,index) in data'</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">'parent'</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">'plain'</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'events'</span>: &#123;</span><br><span class="line">      <span class="string">'click'</span>: &#123;</span><br><span class="line">        <span class="string">'value'</span>: <span class="string">'clickItem(index)'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'hasBindings'</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">'for'</span>: <span class="string">'data'</span>,</span><br><span class="line">    <span class="string">'alias'</span>: <span class="string">'item'</span>,</span><br><span class="line">    <span class="string">'iterator1'</span>: <span class="string">'index'</span>,</span><br><span class="line">    <span class="string">'static'</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'staticRoot'</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'children'</span>: [</span><br><span class="line">      <span class="string">'type'</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">'expression'</span>: <span class="string">'_s(item)+":"+_s(index)'</span></span><br><span class="line">      <span class="string">'text'</span>: <span class="string">'&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;'</span>,</span><br><span class="line">      <span class="string">'tokens'</span>: [</span><br><span class="line">        &#123;<span class="string">'@binding'</span>:<span class="string">'item'</span>&#125;,</span><br><span class="line">        <span class="string">':'</span>,</span><br><span class="line">        &#123;<span class="string">'@binding'</span>:<span class="string">'index'</span>&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">'static'</span>: <span class="literal">false</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¬¬ä¸‰æ­¥-ç”Ÿæˆä»£ç -generate"><a href="#ç¬¬ä¸‰æ­¥-ç”Ÿæˆä»£ç -generate" class="headerlink" title="ç¬¬ä¸‰æ­¥ ç”Ÿæˆä»£ç (generate)"></a>ç¬¬ä¸‰æ­¥ ç”Ÿæˆä»£ç (generate)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = generate(ast, options)</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>generate</code>æ–¹æ³•,å°†ASTç”Ÿæˆrenderå‡½æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> (isShow) ?</span><br><span class="line">    _c(<span class="string">'ul'</span>, &#123;</span><br><span class="line">        staticClass: <span class="string">"list"</span>,</span><br><span class="line">        class: bindCls</span><br><span class="line">      &#125;,</span><br><span class="line">      _l((data), <span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _c(<span class="string">'li'</span>, &#123;</span><br><span class="line">          on: &#123;</span><br><span class="line">            <span class="string">"click"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$event</span>) </span>&#123;</span><br><span class="line">              clickItem(index)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        [_v(_s(item) + <span class="string">":"</span> + _s(index))])</span><br><span class="line">      &#125;)</span><br><span class="line">    ) : _e()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ASTå¯¹è±¡æ–‡æ¡£"><a href="#ASTå¯¹è±¡æ–‡æ¡£" class="headerlink" title="ASTå¯¹è±¡æ–‡æ¡£"></a><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects" target="_blank" rel="noopener">ASTå¯¹è±¡æ–‡æ¡£</a></h2><p>nodeç±»å‹å…¨é›†:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(parameter) node: Identifier | SimpleLiteral | RegExpLiteral | Program | FunctionDeclaration | FunctionExpression | ArrowFunctionExpression | SwitchCase | CatchClause | VariableDeclarator | ExpressionStatement | BlockStatement | EmptyStatement | DebuggerStatement | WithStatement | ReturnStatement | LabeledStatement | BreakStatement | ContinueStatement | IfStatement | SwitchStatement | ThrowStatement | TryStatement | WhileStatement | DoWhileStatement | ForStatement | ForInStatement | ForOfStatement | VariableDeclaration | ClassDeclaration | ThisExpression | ArrayExpression | ObjectExpression | YieldExpression | UnaryExpression | UpdateExpression | BinaryExpression | AssignmentExpression | LogicalExpression | MemberExpression | ConditionalExpression | SimpleCallExpression | NewExpression | SequenceExpression | TemplateLiteral | TaggedTemplateExpression | ClassExpression | MetaProperty | AwaitExpression | Property | AssignmentProperty | Super | TemplateElement | SpreadElement | ObjectPattern | ArrayPattern | RestElement | AssignmentPattern | ClassBody | MethodDefinition | ImportDeclaration | ExportNamedDeclaration | ExportDefaultDeclaration | ExportAllDeclaration | ImportSpecifier | ImportDefaultSpecifier | ImportNamespaceSpecifier | ExportSpecifier</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/babel/babylon/blob/master/ast/spec.md" target="_blank" rel="noopener">https://github.com/babel/babylon/blob/master/ast/spec.md</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://caibaojian.com/ast.html" target="_blank" rel="noopener">http://caibaojian.com/ast.html</a></p>
<p><a href="https://juejin.cn/post/6844904035271573511" target="_blank" rel="noopener">https://juejin.cn/post/6844904035271573511</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects</a></p>
<p><a href="https://segmentfault.com/a/1190000016231512" target="_blank" rel="noopener">https://segmentfault.com/a/1190000016231512</a></p>
<p><a href="https://my.oschina.net/fileoptions/blog/1647448" target="_blank" rel="noopener">https://my.oschina.net/fileoptions/blog/1647448</a></p>
<p><a href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/" target="_blank" rel="noopener">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/</a></p>
<p><a href="https://www.lagou.com/lgeduarticle/82247.html" target="_blank" rel="noopener">https://www.lagou.com/lgeduarticle/82247.html</a></p>
<p><a href="http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview/" target="_blank" rel="noopener">http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview/</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>åŸæ–‡ä½œè€…: </span>
      <a href="https://fynn90.github.io">Fynn</a>
    </p>
    <p class="copyright-item">
      <span>åŸæ–‡é“¾æ¥: </span>
      <a href="https://fynn90.github.io/2020/08/21/ASTæ‡µé€¼å…¥é—¨/">https://fynn90.github.io/2020/08/21/ASTæ‡µé€¼å…¥é—¨/</a>
    </p>
    <p class="copyright-item">
      <span>è®¸å¯åè®®: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨ 4.0 å›½é™…è®¸å¯åè®®</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">èµèµæ”¯æŒ</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/wechat.png" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/alipay.png" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/AST/">AST</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/10/19/JavaåŸºç¡€è¯­æ³•/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">JavaåŸºç¡€è¯­æ³•</span>
        <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
      </a>
    
    
      <a class="next" href="/2020/07/25/Dockerå…¥é—¨/">
        <span class="next-text nav-default">Dockerå…¥é—¨</span>
        <span class="prev-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:fynn.90@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
        
          <a href="https://www.linkedin.com/in/%E5%B8%86-%E9%82%93-17163589/" class="iconfont icon-linkedin" title="linkedin"></a>
        
      
    
      
        
          <a href="https://plus.google.com/u/0/117459332873536225443" class="iconfont icon-google" title="google"></a>
        
      
    
      
        
          <a href="https://github.com/fynn90" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://www.weibo.com/306019091" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
        
          <a href="https://www.zhihu.com/people/FynnDeng/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2020

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Fynn</span>
  </span>
  
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
