<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="AST懵逼入门"/>




  <meta name="keywords" content="AST," />




  <link rel="alternate" href="/atom.xml" title="Fynn's Blog" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1.2" />



<link rel="canonical" href="https://fynn90.github.io/2020/08/21/AST懵逼入门/"/>


<meta name="description" content="AST(Abstract Syntax Tree)抽象语法树,或简称语法树(Syntax tree). 是源代码语法结构的一种抽象表示. 它以树状的形式表现编程语言的语法结构, 树上的每一个节点都表示源代码中的一种结构. 123456while b ≠ 0  if a &gt; b  a :&#x3D; a − b  else  b :&#x3D; b − areturn a">
<meta property="og:type" content="article">
<meta property="og:title" content="AST懵逼入门">
<meta property="og:url" content="https://fynn90.github.io/2020/08/21/AST%E6%87%B5%E9%80%BC%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Fynn&#39;s Blog">
<meta property="og:description" content="AST(Abstract Syntax Tree)抽象语法树,或简称语法树(Syntax tree). 是源代码语法结构的一种抽象表示. 它以树状的形式表现编程语言的语法结构, 树上的每一个节点都表示源代码中的一种结构. 123456while b ≠ 0  if a &gt; b  a :&#x3D; a − b  else  b :&#x3D; b − areturn a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.downk.cc/item/5fc5afa9d590d4788a8bfa5b.png">
<meta property="og:image" content="https://pic.downk.cc/item/5fc9a248394ac52378d2f52e.png">
<meta property="og:image" content="https://pic.downk.cc/item/5fc9fef7394ac52378283bca.png">
<meta property="og:image" content="https://pic.downk.cc/item/5fca01c1394ac523782be68d.png">
<meta property="article:published_time" content="2020-08-21T12:00:00.000Z">
<meta property="article:modified_time" content="2020-12-04T12:49:31.723Z">
<meta property="article:author" content="Fynn">
<meta property="article:tag" content="AST">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.downk.cc/item/5fc5afa9d590d4788a8bfa5b.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1.2" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?607980a031d3edcefed502ce80e77ffb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-115728733-1', 'auto');
        ga('send', 'pageview');
  </script>



    <title> AST懵逼入门 · Fynn's Blog </title>
  <meta name="generator" content="Hexo 5.4.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Fynn's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Fynn's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          AST懵逼入门
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2020年8月21日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-text">AST 能做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-JavaScript"><span class="toc-text">AST-JavaScript</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%8D%95%E5%85%83"><span class="toc-text">语法单元</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#javascript%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E8%AF%AD%E6%B3%95%E5%8D%95%E5%85%83%E4%B8%BB%E8%A6%81%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%8B%E5%87%A0%E7%A7%8D"><span class="toc-text">javascript代码中的语法单元主要包含一下几种:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-text">语法分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recast-%E6%93%8D%E4%BD%9CAST%E7%91%9E%E5%A3%AB%E5%86%9B%E5%88%80"><span class="toc-text">recast - 操作AST瑞士军刀</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-type-builders"><span class="toc-text">recast.type.builders</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recast-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="toc-text">recast 高级用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-run"><span class="toc-text">recast.run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-visit"><span class="toc-text">recast.visit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#recast-types-namedTypes"><span class="toc-text">recast.types.namedTypes</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Babel-%E4%BD%BF%E7%94%A8%E7%9A%84AST-%E5%B7%A5%E5%85%B7%E5%BA%93"><span class="toc-text">Babel 使用的AST 工具库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babel%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">babel插件的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babel%E8%A7%A3%E6%9E%90AST"><span class="toc-text">babel解析AST</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90%F0%9F%8C%B0"><span class="toc-text">例子🌰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E7%82%B9%E4%BE%8B%E5%AD%90%F0%9F%8C%B0"><span class="toc-text">高级点例子🌰</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue%E6%A8%A1%E7%89%88%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B"><span class="toc-text">Vue模版编译过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E8%A7%A3%E6%9E%90-Parse"><span class="toc-text">第一步 解析(Parse)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E4%BC%98%E5%8C%96%E8%AF%AD%E6%B3%95%E6%A0%91-Optimize"><span class="toc-text">第二步 优化语法树(Optimize)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81-generate"><span class="toc-text">第三步 生成代码(generate)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AST%E5%AF%B9%E8%B1%A1%E6%96%87%E6%A1%A3"><span class="toc-text">AST对象文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">AST(Abstract Syntax Tree)</a>抽象语法树,或简称语法树(Syntax tree). 是源代码语法结构的一种抽象表示. 它以<strong>树状</strong>的形式表现编程语言的语法结构, 树上的每一个节点都表示源代码中的一种结构.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> b ≠ <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> a &gt; b</span><br><span class="line">  a := a − b</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  b := b − a</span><br><span class="line"><span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>

<p><img src="https://pic.downk.cc/item/5fc5afa9d590d4788a8bfa5b.png"></p>
<span id="more"></span>


<p>之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于 <code>if-condition-then</code> 这样的条件跳转语句，可以使用带有三个分支的节点来表示。</p>
<p>和抽象语法树相对的是具体语法树（通常称作<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%9E%90%E6%A0%91">分析树</a>）。一般的，在源代码的翻译和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BC%96%E8%AF%91">编译</a>过程中，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AA%9E%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8">语法分析器</a>创建出分析树，然后从分析树生成AST。一旦AST被创建出来，在后续的处理过程中，比如<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AF%AD%E4%B9%89%E5%88%86%E6%9E%90">语义分析</a>阶段，会添加一些信息。</p>
<h2 id="AST-能做什么"><a href="#AST-能做什么" class="headerlink" title="AST 能做什么"></a>AST 能做什么</h2><ul>
<li>语法检查、代码风格检查、格式化代码、语法高亮、错误提示、自动补全等. </li>
<li>代码混淆压缩.</li>
<li>优化变更代码,改变代码结构等.</li>
</ul>
<h2 id="AST-JavaScript"><a href="#AST-JavaScript" class="headerlink" title="AST-JavaScript"></a>AST-JavaScript</h2><p>javascript parser 把JS代码转换成 抽象语法树的解析器.浏览器在执行JS之前会把源码通过解析器转化成抽象语法树,再进一步转换成字节码甚至机器码.</p>
<p>常用的javascript parser有:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/jquery/esprima">Esprima</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mishoo/UglifyJS2">UglifyJS2</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/traceur-compiler">Traceur</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/acornjs/acorn">Acorn</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/eslint/espree">Espree</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shapesecurity/shift-parser-js">Shfit</a></li>
</ul>
<p>在整个解析过程分为两部分:</p>
<ul>
<li>分词: 将整个代码字符串分割成最小<strong>语法单元</strong>数组</li>
<li>语法分析: 在分词基础上建立分析语法单元之间的关系</li>
</ul>
<h3 id="语法单元"><a href="#语法单元" class="headerlink" title="语法单元"></a>语法单元</h3><p>语法单元:被解析语法中具备实际意义的最小单元. </p>
<p>例如:“2019年是祖国70周年”. 这句话拆成最小单元是: “2019年”,“是”,“祖国”,“70”,“周年”. 这些语法单元再进行拆分就失去了它本来要表达的意思.</p>
<h4 id="javascript代码中的语法单元主要包含一下几种"><a href="#javascript代码中的语法单元主要包含一下几种" class="headerlink" title="javascript代码中的语法单元主要包含一下几种:"></a>javascript代码中的语法单元主要包含一下几种:</h4><ul>
<li>关键字: <code>let</code>,<code>const</code>,<code>var</code></li>
<li>标识符: 没有被括号引起的连续字符串,可能是变量,也可能是<code>if</code>,<code>else</code>这些关键字</li>
<li>数字运算符: <code>+</code>、<code>-</code>、<code>*</code>、<code>%</code></li>
<li>数字: 十六进制、十进制、八进制等以及科学表达式等语法</li>
<li>空格: 连续的空格、换行、制表符等</li>
<li>注释: 行注释和大块的块注释作为最小的语法单元</li>
<li>其他: 大括号,小括号,分号,冒号等.</li>
</ul>
<p><strong>例子🌰:</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>+<span class="number">2</span>)*<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>通过分词,我们得到一下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;(&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Numeric&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;+&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Numeric&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;)&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Punctuator&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Numeric&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>在线分词工具:<a target="_blank" rel="noopener" href="https://esprima.org/demo/parse.html#">esprima/parser</a></p>
<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p>分词后得到一个个独立的语法单元, 这些语法单元需要建立其实际的关系才有意义. 建立语法单元的这个过程就是语法分析,这个一般是递归过程.</p>
<p><code>(1+2)*3;</code> 最后的语法分析结果是:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;start&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;end&quot;</span>: <span class="number">186</span>,</span><br><span class="line">  <span class="attr">&quot;body&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ExpressionStatement&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start&quot;</span>: <span class="number">178</span>,</span><br><span class="line">      <span class="attr">&quot;end&quot;</span>: <span class="number">186</span>,</span><br><span class="line">      <span class="attr">&quot;expression&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BinaryExpression&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;start&quot;</span>: <span class="number">178</span>,</span><br><span class="line">        <span class="attr">&quot;end&quot;</span>: <span class="number">185</span>,</span><br><span class="line">        <span class="attr">&quot;left&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;BinaryExpression&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;start&quot;</span>: <span class="number">179</span>,</span><br><span class="line">          <span class="attr">&quot;end&quot;</span>: <span class="number">182</span>,</span><br><span class="line">          <span class="attr">&quot;left&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;start&quot;</span>: <span class="number">179</span>,</span><br><span class="line">            <span class="attr">&quot;end&quot;</span>: <span class="number">180</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;+&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;right&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;start&quot;</span>: <span class="number">181</span>,</span><br><span class="line">            <span class="attr">&quot;end&quot;</span>: <span class="number">182</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;right&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;Literal&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;start&quot;</span>: <span class="number">184</span>,</span><br><span class="line">          <span class="attr">&quot;end&quot;</span>: <span class="number">185</span>,</span><br><span class="line">          <span class="attr">&quot;value&quot;</span>: <span class="number">3</span>,</span><br><span class="line">          <span class="attr">&quot;raw&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;sourceType&quot;</span>: <span class="string">&quot;module&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://astexplorer.net/">astexplorer</a> 在线可视化 AST工具.</p>
<p><code>  body</code>表示程序体，而程序体中包含了一则表达式<code>ExpressionStatement</code>, 表达式体里包含了操作符 <code>*</code>,以及左右两边表达式，其中右边是数字<code>3</code>,而左边表达式还包含一层表达式，里面是一个<code>+</code> 操作符，以及左右两边分别为<code>1</code>和<code>2</code>的数字。</p>
<p><img src="https://pic.downk.cc/item/5fc9a248394ac52378d2f52e.png"></p>
<h3 id="recast-操作AST瑞士军刀"><a href="#recast-操作AST瑞士军刀" class="headerlink" title="recast - 操作AST瑞士军刀"></a>recast - 操作AST瑞士军刀</h3><p><code>recast</code>可以将 JS代码块解析成 AST,并针对AST进行JS代码的修改.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">&#x27;recast&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">  function add(a,b) &#123;</span></span><br><span class="line"><span class="string">    return a+b;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = recast.parse(code);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> add = ast.program.body[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(add)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">FunctionDeclaration &#123;</span></span><br><span class="line"><span class="comment">  type: &#x27;FunctionDeclaration&#x27;,</span></span><br><span class="line"><span class="comment">  id: Identifier &#123;</span></span><br><span class="line"><span class="comment">    type: &#x27;Identifier&#x27;,</span></span><br><span class="line"><span class="comment">    name: &#x27;add&#x27;,</span></span><br><span class="line"><span class="comment">    loc: &#123;</span></span><br><span class="line"><span class="comment">      start: [Object],</span></span><br><span class="line"><span class="comment">      end: [Object],</span></span><br><span class="line"><span class="comment">      lines: [Lines],</span></span><br><span class="line"><span class="comment">      tokens: [Array],</span></span><br><span class="line"><span class="comment">      indent: 2</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  params: [</span></span><br><span class="line"><span class="comment">    Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;a&#x27;, loc: [Object] &#125;,</span></span><br><span class="line"><span class="comment">    Identifier &#123; type: &#x27;Identifier&#x27;, name: &#x27;b&#x27;, loc: [Object] &#125;</span></span><br><span class="line"><span class="comment">  ],</span></span><br><span class="line"><span class="comment">  body: BlockStatement &#123;</span></span><br><span class="line"><span class="comment">    type: &#x27;BlockStatement&#x27;,</span></span><br><span class="line"><span class="comment">    body: [ [ReturnStatement] ],</span></span><br><span class="line"><span class="comment">    loc: &#123;</span></span><br><span class="line"><span class="comment">      start: [Object],</span></span><br><span class="line"><span class="comment">      end: [Object],</span></span><br><span class="line"><span class="comment">      lines: [Lines],</span></span><br><span class="line"><span class="comment">      tokens: [Array],</span></span><br><span class="line"><span class="comment">      indent: 2</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  generator: false,</span></span><br><span class="line"><span class="comment">  expression: false,</span></span><br><span class="line"><span class="comment">  async: false,</span></span><br><span class="line"><span class="comment">  loc: &#123;</span></span><br><span class="line"><span class="comment">    start: &#123; line: 2, column: 2, token: 0 &#125;,</span></span><br><span class="line"><span class="comment">    end: &#123; line: 4, column: 3, token: 14 &#125;,</span></span><br><span class="line"><span class="comment">    lines: Lines &#123;</span></span><br><span class="line"><span class="comment">      infos: [Array],</span></span><br><span class="line"><span class="comment">      mappings: [],</span></span><br><span class="line"><span class="comment">      cachedSourceMap: null,</span></span><br><span class="line"><span class="comment">      cachedTabWidth: undefined,</span></span><br><span class="line"><span class="comment">      length: 5,</span></span><br><span class="line"><span class="comment">      name: null</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    tokens: [</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object]</span></span><br><span class="line"><span class="comment">    ],</span></span><br><span class="line"><span class="comment">    indent: 2</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(add.params[<span class="number">0</span>])</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Identifier &#123;</span></span><br><span class="line"><span class="comment">  type: &#x27;Identifier&#x27;,</span></span><br><span class="line"><span class="comment">  name: &#x27;a&#x27;,</span></span><br><span class="line"><span class="comment">  loc: &#123;</span></span><br><span class="line"><span class="comment">    start: &#123; line: 2, column: 15, token: 3 &#125;,</span></span><br><span class="line"><span class="comment">    end: &#123; line: 2, column: 16, token: 4 &#125;,</span></span><br><span class="line"><span class="comment">    lines: Lines &#123;</span></span><br><span class="line"><span class="comment">      infos: [Array],</span></span><br><span class="line"><span class="comment">      mappings: [],</span></span><br><span class="line"><span class="comment">      cachedSourceMap: null,</span></span><br><span class="line"><span class="comment">      cachedTabWidth: undefined,</span></span><br><span class="line"><span class="comment">      length: 5,</span></span><br><span class="line"><span class="comment">      name: null</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    tokens: [</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object],</span></span><br><span class="line"><span class="comment">      [Object], [Object]</span></span><br><span class="line"><span class="comment">    ],</span></span><br><span class="line"><span class="comment">    indent: 2</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="recast-type-builders"><a href="#recast-type-builders" class="headerlink" title="recast.type.builders"></a>recast.type.builders</h4><p><code>recast.type.builders</code>提供各种工具用于AST结构的组装,以帮助对于AST结构修改.</p>
<p>定一个小小的目标:</p>
<p><code>function add(a,b) &#123;&#125;</code>改成匿名函数式声明<code>const add = function (a,b) &#123;...&#125;</code></p>
<p>步骤:</p>
<ol>
<li>创建一个<code>VariableDeclaration</code>变量声明对象, 声明头为<code>const</code>, 内容为一个即将创建的<code>VariableDeclarator</code>对象.</li>
<li>创建一个<code>VariableDeclarator</code>,放置<code>add.id</code>在左边,右边是将创建的<code>FunctionDeclaration</code>对象</li>
<li>创建一个<code>FunctionDeclaration</code>,包含前面前所述的三个组件<code>id</code>,<code>params</code>,<code>body</code>. 因为是匿名函数则id设为空,<code>params</code>使用<code>add.params</code>,<code>body</code>使用<code>add.body</code>.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">&#x27;recast&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">  function add(a,b) &#123;</span></span><br><span class="line"><span class="string">    return a+b;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = recast.parse(code);</span><br><span class="line"><span class="keyword">const</span> add = ast.program.body[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入变量声明，变量符号，函数声明三种“模具”</span></span><br><span class="line"><span class="keyword">const</span> &#123;variableDeclaration, variableDeclarator, functionExpression&#125; = recast.types.builders</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将准备好的组件置入模具，并组装回原来的ast对象。</span></span><br><span class="line">ast.program.body[<span class="number">0</span>] = variableDeclaration(<span class="string">&quot;const&quot;</span>, [</span><br><span class="line">  variableDeclarator(add.id, functionExpression(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// Anonymize the function expression.</span></span><br><span class="line">    add.params,</span><br><span class="line">    add.body</span><br><span class="line">  ))</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将AST对象重新转回可以阅读的代码</span></span><br><span class="line"><span class="keyword">const</span> output = recast.print(ast).code;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  const add = function(a, b) &#123;</span></span><br><span class="line"><span class="comment">    return a+b;</span></span><br><span class="line"><span class="comment">  &#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="recast-高级用法"><a href="#recast-高级用法" class="headerlink" title="recast 高级用法"></a>recast 高级用法</h3><p>除了<code>parse/print/builder</code>,Recaset的三项主要功能:</p>
<ul>
<li><code>recast.run</code>: 通过命令行读取js文件, 并转化成AST以供处理.</li>
<li><code>recast.types.namedTypes</code>: 通过<code>assert()</code>和<code>check()</code>,可以验证AST对象的类型.</li>
<li><code>recast.visit</code>: 遍历AST树, 获取有效的AST对象并进行更改.</li>
</ul>
<h4 id="recast-run"><a href="#recast-run" class="headerlink" title="recast.run"></a><code>recast.run</code></h4><p>demo.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonDivision</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (b !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">      a = sub(a, b)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      b = sub(b, a)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">&#x27;recast&#x27;</span>)</span><br><span class="line">recast.run( <span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>)</span>&#123;</span><br><span class="line">    printSource(ast)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>命令行输入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">node <span class="built_in">read</span> demo.js</span><br><span class="line"></span><br><span class="line">// <span class="keyword">function</span> add(a, b) &#123;</span><br><span class="line">//  <span class="built_in">return</span> a + b</span><br><span class="line">//&#125;</span><br><span class="line">//</span><br><span class="line">//<span class="keyword">function</span> sub(a, b) &#123;</span><br><span class="line">//  <span class="built_in">return</span> a - b</span><br><span class="line">//&#125;</span><br><span class="line">//</span><br><span class="line">//<span class="keyword">function</span> commonDivision(a, b) &#123;</span><br><span class="line">//  <span class="keyword">while</span> (b !== 0) &#123;</span><br><span class="line">//    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">//      a = sub(a, b)</span><br><span class="line">//    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">//      b = sub(b, a)</span><br><span class="line">//    &#125;</span><br><span class="line">//  &#125;</span><br><span class="line">//  <span class="built_in">return</span> a</span><br><span class="line">//&#125;%  </span><br></pre></td></tr></table></figure>

<p><code>recast.run</code>读取demo.js文件,并将内容转成了AST对象.</p>
<p>同时它还提供了一个<code>printSource</code>函数，随时可以将ast的内容转换回源码，以方便调试。</p>
<h4 id="recast-visit"><a href="#recast-visit" class="headerlink" title="recast.visit"></a><code>recast.visit</code></h4><p>visit.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast  = <span class="built_in">require</span>(<span class="string">&#x27;recast&#x27;</span>)</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      <span class="attr">visitExpressionStatement</span>: <span class="function"><span class="keyword">function</span>(<span class="params">&#123;node&#125;</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(node)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>recast.visit将AST对象内的节点进行逐个遍历</p>
<p><strong>注意:</strong></p>
<ol>
<li>你想操作函数声明,就使用<code>visitFunctionDelaration</code>遍历,想操作赋值表达式,就使用<code>visitExpressionStatement</code>.只要在<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects">AST对象文档</a>中的定义对象,在前面增加<code>visit</code>就可遍历</li>
<li>通过<code>node</code>可以取到AST对象</li>
<li>每个遍历函数后必须加上return false，或者选择以下写法，否则报错：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast  = <span class="built_in">require</span>(<span class="string">&#x27;recast&#x27;</span>)</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      <span class="attr">visitExpressionStatement</span>: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.node</span><br><span class="line">        printSource(node)</span><br><span class="line">        <span class="built_in">this</span>.traverse(path)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="recast-types-namedTypes"><a href="#recast-types-namedTypes" class="headerlink" title="recast.types.namedTypes"></a><code>recast.types.namedTypes</code></h4><p><code>recast.types.namedTypes</code>简称<code>TNT</code>,它用来判断AST对象是否为指定的类型.</p>
<p><code>TNT.Node.assert()</code>判断<code>Node</code>是否规范,如果不符合规范则报错退出</p>
<p><code>TNT.Node.check()</code>可以判断类型是否一致,并输出<code>False</code>和<code>True</code></p>
<p><strong>注意:</strong> 上述Node可以替换成任意AST对象，例如TNT.ExpressionStatement.check(),TNT.FunctionDeclaration.assert()</p>
<p>check.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">&quot;recast&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> TNT = recast.types.namedTypes</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      <span class="attr">visitExpressionStatement</span>: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.value</span><br><span class="line">        <span class="comment">// 判断是否为ExpressionStatement，正确则输出一行字。</span></span><br><span class="line">        <span class="keyword">if</span>(TNT.ExpressionStatement.check(node))&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;这是一个ExpressionStatement&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.traverse(path);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>assert.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> recast = <span class="built_in">require</span>(<span class="string">&quot;recast&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> TNT = recast.types.namedTypes</span><br><span class="line"></span><br><span class="line">recast.run(<span class="function"><span class="keyword">function</span>(<span class="params">ast, printSource</span>) </span>&#123;</span><br><span class="line">  recast.visit(ast, &#123;</span><br><span class="line">      <span class="attr">visitExpressionStatement</span>: <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> node = path.node</span><br><span class="line">        <span class="comment">// 判断是否为ExpressionStatement，正确不输出，错误则全局报错</span></span><br><span class="line">        TNT.ExpressionStatement.assert(node)</span><br><span class="line">        <span class="built_in">this</span>.traverse(path);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Babel-使用的AST-工具库"><a href="#Babel-使用的AST-工具库" class="headerlink" title="Babel 使用的AST 工具库"></a>Babel 使用的AST 工具库</h2><p>babel 就出现了，它主要解决了就是一些浏览器不兼容 Es6 新特性的问题，其实就把 Es6 代码转换为 Es5 的代码，兼容所有浏览器，babel 转换代码其实就是用了 AST，babel 与 AST 就有着很一种特别的关系。</p>
<p>当我们配置 babel 的时候，不管是在 <code>.babelrc</code> 或者 <code>babel.config.js</code> 文件里面配置的都有 <code>presets</code> 和 <code>plugins</code> 两个配置项:</p>
<p>插件和预设的区别</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;presets&quot;</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们配置了 <code>presets</code> 中有 <code>@babel/preset-env</code>，那么 <code>@babel/core</code> 就会去找 <code>preset-env</code> 预设的插件包，它是一套</p>
<p>babel 核心包并不会去转换代码，核心包只提供一些核心 API，真正的代码转换工作由插件或者预设来完成，比如要转换箭头函数，会用到这个 plugin，<code>@babel/plugin-transform-arrow-functions</code>，当需要转换的要求增加时，我们不可能去一一配置相应的 plugin，这个时候就可以用到预设了，也就是 presets。presets 是 plugins 的集合，一个 presets 内部包含了很多 plugin。</p>
<h3 id="babel插件的使用"><a href="#babel插件的使用" class="headerlink" title="babel插件的使用"></a>babel插件的使用</h3><p>使用插件集合<code>@babel/preset-env</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`const fn = (a, b) =&gt; a + b`</span></span><br><span class="line"><span class="comment">// babel 有 transform 方法会帮我们自动遍历，使用相应的预设或者插件转换相应的代码</span></span><br><span class="line"><span class="keyword">const</span> r = babel.transform(code, &#123;</span><br><span class="line">  <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r.code)</span><br><span class="line"><span class="comment">// 打印结果如下</span></span><br><span class="line"><span class="comment">// &quot;use strict&quot;;</span></span><br><span class="line"><span class="comment">// var fn = function fn(a,b) &#123; return a + b; &#125;;</span></span><br></pre></td></tr></table></figure>

<p>使用单独的差距<code>@babel/plugin-transform-arrow-functions</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`const fn = (a, b) =&gt; a + b`</span></span><br><span class="line"><span class="comment">// babel 有 transform 方法会帮我们自动遍历，使用相应的预设或者插件转换相应的代码</span></span><br><span class="line"><span class="keyword">const</span> r = babel.transform(code, &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="string">&#x27;@babel/plugin-transform-arrow-functions&#x27;</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r.code)</span><br><span class="line"><span class="comment">// 打印结果如下</span></span><br><span class="line"><span class="comment">// const fn = function (a,b) &#123; return a + b; &#125;;</span></span><br></pre></td></tr></table></figure>

<p>我们可以从打印结果发现此时并没有转换我们变量的声明方式还是 const 声明，只是转换了箭头函数</p>
<h3 id="babel解析AST"><a href="#babel解析AST" class="headerlink" title="babel解析AST"></a>babel解析AST</h3><p><code>babel</code>使用的AST引擎是<code>babylon</code>,<code>babylon</code>并非<code>babel</code>团队自己开发,而是fork<code>acorn</code>项目.</p>
<p>如果我们使用<code>babel</code>处理AST对象,只需要使用:</p>
<ul>
<li><code>@babel/parser</code>: 将js代码 —&gt; AST对象</li>
<li><code>@babel/traverse</code>: 对AST节点进行递归遍历</li>
<li><code>@babel/types</code>: 对具体的AST节点进行修改</li>
<li><code>@babel/generator</code>: <code>AST</code>对象 —&gt;新的js代码.</li>
</ul>
<p>babel解析过程分为3个阶段:</p>
<p><img src="https://pic.downk.cc/item/5fc9fef7394ac52378283bca.png"></p>
<ul>
<li><p>第1步 解析（Parse）通过解析器babylon将代码解析成抽象语法树</p>
</li>
<li><p>第2步 转换（TransForm）通过babel-traverse plugin对抽象语法树进行深度优先遍历，遇到需要转换的，就直接在AST对象上对节点进行添加、更新及移除操作，比如遇到箭头函数，就转换成普通函数，最后得到新的AST树。</p>
</li>
<li><p>第3步 生成（Generate）通过babel-generator将AST树生成es5代码</p>
</li>
</ul>
<h4 id="例子🌰"><a href="#例子🌰" class="headerlink" title="例子🌰"></a>例子🌰</h4><p>简单的跑下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> types = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 1.parse 将代码解析为抽象语法树（AST）</span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(code);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2,traverse 转换代码</span></span><br><span class="line">  traverse.default(ast, &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. generator 将 AST 转回成代码</span></span><br><span class="line">  <span class="keyword">return</span> generator.default(ast, &#123;&#125;, code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function getData() &#123;</span></span><br><span class="line"><span class="string">  console.log(&quot;data&quot;)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> newCode = compile(code)</span><br><span class="line"><span class="built_in">console</span>.log(newCode)</span><br></pre></td></tr></table></figure>

<h4 id="高级点例子🌰"><a href="#高级点例子🌰" class="headerlink" title="高级点例子🌰"></a>高级点例子🌰</h4><p>自动给<code>console.log</code>增加函数名</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&quot;@babel/traverse&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> types = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 1.parse</span></span><br><span class="line">  <span class="keyword">const</span> ast = parser.parse(code);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2,traverse</span></span><br><span class="line">  <span class="keyword">const</span> visitor = &#123;</span><br><span class="line">    <span class="function"><span class="title">CallExpression</span>(<span class="params">path</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 拿到 callee 数据</span></span><br><span class="line">      <span class="keyword">const</span> &#123; callee &#125; = path.node;</span><br><span class="line">      <span class="comment">// 判断是否是调用了 console.log 方法</span></span><br><span class="line">      <span class="comment">// 1. 判断是否是成员表达式节点，上面截图有详细介绍</span></span><br><span class="line">      <span class="comment">// 2. 判断是否是 console 对象</span></span><br><span class="line">      <span class="comment">// 3. 判断对象的属性是否是 log</span></span><br><span class="line">      <span class="keyword">const</span> isConsoleLog =</span><br><span class="line">        types.isMemberExpression(callee) &amp;&amp;</span><br><span class="line">        callee.object.name === <span class="string">&quot;console&quot;</span> &amp;&amp;</span><br><span class="line">        callee.property.name === <span class="string">&quot;log&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> (isConsoleLog) &#123;</span><br><span class="line">        <span class="comment">// 如果是 console.log 的调用 找到上一个父节点是函数</span></span><br><span class="line">        <span class="keyword">const</span> funcPath = path.findParent(<span class="function"><span class="params">p</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> p.isFunctionDeclaration();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 取函数的名称</span></span><br><span class="line">        <span class="keyword">const</span> funcName = funcPath.node.id.name;</span><br><span class="line">        <span class="comment">// 将名称通过 types 来放到函数的参数前面去</span></span><br><span class="line">        path.node.arguments.unshift(types.stringLiteral(funcName));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// traverse 转换代码</span></span><br><span class="line">  traverse.default(ast, visitor);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. generator 将 AST 转回成代码</span></span><br><span class="line">  <span class="keyword">return</span> generator.default(ast, &#123;&#125;, code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function getData() &#123;</span></span><br><span class="line"><span class="string">  console.log(&quot;data&quot;)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> newCode = compile(code)</span><br><span class="line"><span class="built_in">console</span>.log(newCode)</span><br></pre></td></tr></table></figure>




<h2 id="Vue模版编译过程"><a href="#Vue模版编译过程" class="headerlink" title="Vue模版编译过程"></a>Vue模版编译过程</h2><p>Vue提供了2个版本,一个是Runtime+Compiler,另一个是Runtime only.</p>
<p>Runtime+Compiler是包含编译代码的,会把编译的过程放到运行时做.</p>
<p>Runtime only是不包含编译代码的,需要借助wenpack的vue-loader把模版编译成render函数.</p>
<p>无论是那个版本,都会有一个环节将模版编译成render函数.</p>
<p><img src="https://pic.downk.cc/item/5fca01c1394ac523782be68d.png"></p>
<h3 id="第一步-解析-Parse"><a href="#第一步-解析-Parse" class="headerlink" title="第一步 解析(Parse)"></a>第一步 解析(Parse)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ast = parse(template.trim(), options)</span><br></pre></td></tr></table></figure>

<p>将模板字符串解析生成 AST,这里的解析器是vue自己实现的，解析过程中会使用正则表达式对模板顺序解析，当解析到开始标签、闭合标签、文本的时候都会有相对应的回调函数执行，来达到构造 AST 树的目的。</p>
<p>生成的AST 元素节点总共有 3 种类型，1 为普通元素， 2 为表达式，3为纯文本。</p>
<p>例子🌰</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">:class</span>=<span class="string">&quot;bindCls&quot;</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in data&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;clickItem(index)&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面👆模版解析成AST对象如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;ul&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;attrsList&#x27;</span>: [],</span><br><span class="line">  <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;:class&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v-if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;ifConditions&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;exp&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">&#x27;parent&#x27;</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticClass&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;classBinding&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;children&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;attrsList&#x27;</span>: [&#123;</span><br><span class="line">      <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;@click&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@click&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;v-for&#x27;</span>: <span class="string">&#x27;(item,index) in data&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">&#x27;parent&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;events&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;click&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hasBindings&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;for&#x27;</span>: <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;alias&#x27;</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iterator1&#x27;</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">      <span class="string">&#x27;type&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">&#x27;expression&#x27;</span>: <span class="string">&#x27;_s(item)+&quot;:&quot;+_s(index)&#x27;</span></span><br><span class="line">      <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;tokens&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;item&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;index&#x27;</span>&#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第二步-优化语法树-Optimize"><a href="#第二步-优化语法树-Optimize" class="headerlink" title="第二步 优化语法树(Optimize)"></a>第二步 优化语法树(Optimize)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optimize(ast, options)</span><br></pre></td></tr></table></figure>

<p>Vue模版中并不是所有数据都是响应式的,有很多数据在首次渲染后就永远不会改变了. 那么这部分数据生成的DOM也不会改变, 我们可以在patch的过程跳过他们的对比.</p>
<p>此阶段会深度遍历生成的AST树,检测它的每一颗子树是不是静态节点,如果是静态节点则它们生成DOM永远不会改变,这对运行时对模版的更新起到极大的优化作用.</p>
<p>遍历过程中,会对这个AST树中的每一个AST元素节点标记static和staticRoot(递归该节点的所有children,一旦子节点有不是static的情况,则为false,否则为true).</p>
<p> 经过该阶段,上面例子中的AST会变成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;ul&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;attrsList&#x27;</span>: [],</span><br><span class="line">  <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;:class&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v-if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;ifConditions&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;exp&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">&#x27;parent&#x27;</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticClass&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;classBinding&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticRoot&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;children&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;attrsList&#x27;</span>: [&#123;</span><br><span class="line">      <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;@click&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@click&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;v-for&#x27;</span>: <span class="string">&#x27;(item,index) in data&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">&#x27;parent&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;events&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;click&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hasBindings&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;for&#x27;</span>: <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;alias&#x27;</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iterator1&#x27;</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;staticRoot&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">      <span class="string">&#x27;type&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">&#x27;expression&#x27;</span>: <span class="string">&#x27;_s(item)+&quot;:&quot;+_s(index)&#x27;</span></span><br><span class="line">      <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;tokens&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;item&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;index&#x27;</span>&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第三步-生成代码-generate"><a href="#第三步-生成代码-generate" class="headerlink" title="第三步 生成代码(generate)"></a>第三步 生成代码(generate)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = generate(ast, options)</span><br></pre></td></tr></table></figure>

<p>通过<code>generate</code>方法,将AST生成render函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">with</span>(<span class="params"><span class="built_in">this</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (isShow) ?</span><br><span class="line">    _c(<span class="string">&#x27;ul&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">staticClass</span>: <span class="string">&quot;list&quot;</span>,</span><br><span class="line">        <span class="attr">class</span>: bindCls</span><br><span class="line">      &#125;,</span><br><span class="line">      _l((data), <span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _c(<span class="string">&#x27;li&#x27;</span>, &#123;</span><br><span class="line">          <span class="attr">on</span>: &#123;</span><br><span class="line">            <span class="string">&quot;click&quot;</span>: <span class="function"><span class="keyword">function</span>(<span class="params">$event</span>) </span>&#123;</span><br><span class="line">              clickItem(index)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        [_v(_s(item) + <span class="string">&quot;:&quot;</span> + _s(index))])</span><br><span class="line">      &#125;)</span><br><span class="line">    ) : _e()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="AST对象文档"><a href="#AST对象文档" class="headerlink" title="AST对象文档"></a><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects">AST对象文档</a></h2><p>node类型全集:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(parameter) node: Identifier | SimpleLiteral | RegExpLiteral | Program | FunctionDeclaration | FunctionExpression | ArrowFunctionExpression | SwitchCase | CatchClause | VariableDeclarator | ExpressionStatement | BlockStatement | EmptyStatement | DebuggerStatement | WithStatement | ReturnStatement | LabeledStatement | BreakStatement | ContinueStatement | IfStatement | SwitchStatement | ThrowStatement | TryStatement | WhileStatement | DoWhileStatement | ForStatement | ForInStatement | ForOfStatement | VariableDeclaration | ClassDeclaration | ThisExpression | ArrayExpression | ObjectExpression | YieldExpression | UnaryExpression | UpdateExpression | BinaryExpression | AssignmentExpression | LogicalExpression | MemberExpression | ConditionalExpression | SimpleCallExpression | NewExpression | SequenceExpression | TemplateLiteral | TaggedTemplateExpression | ClassExpression | MetaProperty | AwaitExpression | Property | AssignmentProperty | Super | TemplateElement | SpreadElement | ObjectPattern | ArrayPattern | RestElement | AssignmentPattern | ClassBody | MethodDefinition | ImportDeclaration | ExportNamedDeclaration | ExportDefaultDeclaration | ExportAllDeclaration | ImportSpecifier | ImportDefaultSpecifier | ImportNamespaceSpecifier | ExportSpecifier</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/babel/babylon/blob/master/ast/spec.md">https://github.com/babel/babylon/blob/master/ast/spec.md</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://caibaojian.com/ast.html">http://caibaojian.com/ast.html</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904035271573511">https://juejin.cn/post/6844904035271573511</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#Node_objects</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016231512">https://segmentfault.com/a/1190000016231512</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/fileoptions/blog/1647448">https://my.oschina.net/fileoptions/blog/1647448</a></p>
<p><a target="_blank" rel="noopener" href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/">https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/726217/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.lagou.com/lgeduarticle/82247.html">https://www.lagou.com/lgeduarticle/82247.html</a></p>
<p><a target="_blank" rel="noopener" href="http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview/">http://www.alloyteam.com/2017/04/analysis-of-babel-babel-overview/</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>Fynn</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="https://fynn90.github.io">https://fynn90.github.io</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="https://fynn90.github.io/2020/08/21/AST%E6%87%B5%E9%80%BC%E5%85%A5%E9%97%A8/">https://fynn90.github.io/2020/08/21/AST%E6%87%B5%E9%80%BC%E5%85%A5%E9%97%A8/</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/wechat.png" title="wechat">
          <div>wechat</div>
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/alipay.png" title="alipay">
          <div>alipay</div>
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/AST/">AST</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2020/10/19/Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Java基础语法</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2020/07/25/Docker%E5%85%A5%E9%97%A8/">
        <span class="next-text nav-default">Docker入门</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:fynn.90@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/%E5%B8%86-%E9%82%93-17163589/" class="iconfont icon-linkedin" title="linkedin"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="https://plus.google.com/u/0/117459332873536225443" class="iconfont icon-google" title="google"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="https://github.com/fatefan" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="http://www.weibo.com/306019091" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/FynnDeng/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
    
    
  </div>


<div class="copyright">
  
  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2021

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Fynn</span>
  </span>
  
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=1.1.2"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1.2"></script>

    
  </body>
</html>
