<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="TS装饰器"/>




  <meta name="keywords" content="decorator, Fynn's Blog" />










  <link rel="alternate" href="/atom.xml" title="Fynn's Blog" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://fynn90.github.io/2021/01/15/TS装饰器/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?607980a031d3edcefed502ce80e77ffb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-115728733-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "jH321kB4p1r5FNrL8YBCwbrG-gzGzoHsz",
      appKey: "Q8vnaBtTzmVPbVX8tdzM7z7w"
    });
  </script>





    <title> TS装饰器 - Fynn's Blog </title>
  <meta name="generator" content="Hexo 5.4.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Fynn's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/categories/">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Fynn's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            
            
              分类
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          TS装饰器
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-01-15
        </span>
        
          <div class="post-category">
            
              <a href="/categories/TypeScript/">TypeScript</a>
            
          </div>
        
        
        <div class="post-visits"
             data-url="/2021/01/15/TS%E8%A3%85%E9%A5%B0%E5%99%A8/"
             data-title="TS装饰器">
            阅读次数
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">为什么需要装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8%E6%96%B9%E5%BC%8F"><span class="toc-text">没有使用装饰器方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">使用装饰器的方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA"><span class="toc-text">装饰器函数执行时机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%90%AF%E7%94%A8"><span class="toc-text">如何启用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E7%A7%8D%E7%B1%BB"><span class="toc-text">装饰器种类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Typescript-%E4%B8%AD%E7%9A%84-Decorator-%E7%AD%BE%E5%90%8D"><span class="toc-text">Typescript 中的 Decorator 签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">Class 装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">扩展构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8E%9F%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-text">修改原有属性的描述符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%97%AD%E5%8C%85%E6%9D%A5%E5%A2%9E%E5%BC%BA%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">使用闭包来增强装饰器的功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E6%97%A7%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">覆盖旧的构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">多个装饰器的应用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">Method 装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80-%E4%BF%AE%E6%94%B9%E7%8E%B0%E6%9C%89%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-text">方案一 修改现有描述符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C-%E8%BF%94%E5%9B%9E%E6%96%B0%E7%9A%84value%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-text">方案二 返回新的value描述符</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Property-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">Property 装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Parameter-%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">Parameter 装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E7%AC%A6%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-text">访问符装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%AE%9E%E4%BE%8B%E7%B1%BB%E5%9E%8B"><span class="toc-text">静态类型和实例类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%B1%9E%E6%80%A7"><span class="toc-text">什么是静态属性和实例属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96-descriptor"><span class="toc-text">静态属性手动获取 descriptor</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">装饰器执行顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%B7%A5%E5%8E%82%F0%9F%8F%AD"><span class="toc-text">装饰工厂🏭</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">装饰器的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">装饰器代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">控制器代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">路由器代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E4%BB%A3%E7%A0%81"><span class="toc-text">创建路由代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Refer-To"><span class="toc-text">Refer To</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <blockquote>
<p>装饰器（Decorators）是一种特殊的声明，可附加在类、方法、访问器、属性、参数声明上。</p>
</blockquote>
<p>装饰器（Decorators）可以通过<strong>非侵入</strong>方式增强<strong>类</strong>、<strong>方法</strong>、<strong>访问器</strong>、<strong>属性</strong>、<strong>参数</strong>的能力。可以将业务逻辑代码和特殊能力和服务的代码分割开来，保证代码的灵活性和扩展性，合理的利用装饰器可以极大的提高我们的开发效率。</p>
<p><strong>注意：</strong> 同样的滥用装饰器也会使代码本身逻辑变得扑朔迷离，如果确定一段代码不会在其他地方用到，或者一个函数的核心逻辑就是这些代码，那么就没有必要将它取出来作为一个装饰器来存在。</p>
<h2 id="为什么需要装饰器"><a href="#为什么需要装饰器" class="headerlink" title="为什么需要装饰器"></a>为什么需要装饰器</h2><p>例如： 我们想记录一个方法执行的耗时</p>
<h3 id="没有使用装饰器方式"><a href="#没有使用装饰器方式" class="headerlink" title="没有使用装饰器方式"></a>没有使用装饰器方式</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">getData</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 此处省略获取数据的逻辑</span></span><br><span class="line">      <span class="keyword">return</span> [&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Niko&#x27;</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Bellic&#x27;</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> end = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`start: <span class="subst">$&#123;start&#125;</span> end: <span class="subst">$&#123;end&#125;</span> consume: <span class="subst">$&#123;end - start&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// start: XXX end: XXX consume: XXX</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> Model1().getData())     <span class="comment">// [ &#123; id: 1, name: &#x27;Niko&#x27;&#125;, &#123; id: 2, name: &#x27;Bellic&#x27; &#125; ]</span></span><br><span class="line"><span class="comment">// start: XXX end: XXX consume: XXX</span></span><br><span class="line"><span class="built_in">console</span>.log(Model1.prototype.getData()) <span class="comment">// [ &#123; id: 1, name: &#x27;Niko&#x27;&#125;, &#123; id: 2, name: &#x27;Bellic&#x27; &#125; ]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面代码中，<code>getData</code>方法中包含了一些非业务的逻辑代码。而这些代码还是不可复用的。</p>
<h3 id="使用装饰器的方式"><a href="#使用装饰器的方式" class="headerlink" title="使用装饰器的方式"></a>使用装饰器的方式</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">target, descriptor, descriptor</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">    ...descriptor,</span><br><span class="line">    <span class="attr">value</span>: <span class="function"><span class="keyword">function</span> (<span class="params">...arg</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> descriptor.value.apply(<span class="built_in">this</span>, arg) <span class="comment">// 调用之前的函数</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> end = <span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`start: <span class="subst">$&#123;start&#125;</span> end: <span class="subst">$&#123;end&#125;</span> consume: <span class="subst">$&#123;end - start&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model1</span> </span>&#123;</span><br><span class="line">  <span class="meta">@log</span></span><br><span class="line">  <span class="function"><span class="title">getData</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Niko&#x27;</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Bellic&#x27;</span></span><br><span class="line">      &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中，我们将增加了一个<code>log</code>用来记录方法执行的时间。通过装饰器我们将业务逻辑和非业务逻辑代码分割开来。</p>
<span id="more"></span>

<h2 id="装饰器函数执行时机"><a href="#装饰器函数执行时机" class="headerlink" title="装饰器函数执行时机"></a>装饰器函数执行时机</h2><p>装饰器对类的行为的改变，是代码编译时发生的，而不是在运行时。这意味着，修饰器能在编译阶段运行代码。也就是说，修饰器本质就是编译时执行的函数。</p>
<ul>
<li>创建类和创建函数时立即执行装饰器</li>
<li>如果装饰器函数返回一个function，这个function会在所有的装饰器函数运行完毕后，继续运行</li>
</ul>
<h2 id="如何启用"><a href="#如何启用" class="headerlink" title="如何启用"></a>如何启用</h2><p>目前 <a target="_blank" rel="noopener" href="https://tc39.es/proposal-decorators/#sec-intro">装饰器(Decorators)</a>处于ECMAscript提案第二阶段（Stage2 Draft）。目前Typescript已经支持，只需要在<code>tsconfig.json</code>做一下简单配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;ES5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="装饰器种类"><a href="#装饰器种类" class="headerlink" title="装饰器种类"></a>装饰器种类</h2><p>Typescript中装饰器有五种类型：</p>
<table>
<thead>
<tr>
<th><strong>装饰器/属性</strong></th>
<th><strong>类 装饰器</strong></th>
<th><strong>方法 装饰器</strong></th>
<th><strong>访问器 装饰器</strong></th>
<th><strong>属性 装饰器</strong></th>
<th><strong>参数 装饰器</strong></th>
</tr>
</thead>
<tbody><tr>
<td>位置</td>
<td><strong>@foo class Bar {}</strong></td>
<td><strong>@foo public bar() {}</strong></td>
<td><strong>@foo get bar()</strong></td>
<td><strong>@foo() bar: number</strong></td>
<td><strong>bar(@foo para: string) {}</strong></td>
</tr>
<tr>
<td>传入参数</td>
<td>constructor</td>
<td>target, <br />propertyKey, <br />descriptor</td>
<td>target, <br />propertyKey,<br /> descriptor</td>
<td>target, propertyKey</td>
<td>target, <br />propertyKey, <br />parameterIndex</td>
</tr>
<tr>
<td>返回值</td>
<td>用返回值提供的构造函数来替换类的声明</td>
<td>返回值被用作方法的属性描述符</td>
<td>返回值被用作方法的属性描述符</td>
<td>被忽略</td>
<td>被忽略</td>
</tr>
</tbody></table>
<p>参数释义：</p>
<ul>
<li><code>constructor</code>: 类构造函数</li>
<li><code>target</code>: 对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。</li>
<li><code>propertyKey</code>: 成员的名字</li>
<li><code>descriptor</code>: 成员的属性描述符</li>
<li><code>parameterIndex</code>: 参数在函数参数列表中的索引</li>
</ul>
<h3 id="Typescript-中的-Decorator-签名"><a href="#Typescript-中的-Decorator-签名" class="headerlink" title="Typescript 中的 Decorator 签名"></a>Typescript 中的 Decorator 签名</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TypedPropertyDescriptor&lt;T&gt; &#123;</span><br><span class="line">    enumerable?: <span class="built_in">boolean</span>;</span><br><span class="line">    configurable?: <span class="built_in">boolean</span>;</span><br><span class="line">    writable?: <span class="built_in">boolean</span>;</span><br><span class="line">    value?: T;</span><br><span class="line"> get?: <span class="function">() =&gt;</span> T;</span><br><span class="line"> set?: <span class="function">(<span class="params">value: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ClassDecorator = &lt;TFunction extends Function&gt;(target: TFunction) =&gt; TFunction | void;</span><br><span class="line"></span><br><span class="line">declare type PropertyDecorator = (target: Object, propertyKey: string | symbol) =&gt; void;</span><br><span class="line"></span><br><span class="line">declare type MethodDecorator = &lt;T&gt;(target: Object, propertyKey: string | symbol, descriptor: TypedPropertyDescriptor&lt;T&gt;) =&gt; TypedPropertyDescriptor&lt;T&gt; | void;</span><br><span class="line"></span><br><span class="line">declare type ParameterDecorator = (target: Object, propertyKey: string | symbol, parameterIndex: number) =&gt; void;</span><br></pre></td></tr></table></figure>

<h3 id="Class-装饰器"><a href="#Class-装饰器" class="headerlink" title="Class 装饰器"></a>Class 装饰器</h3><p>类装饰器的类型定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ClassDecorator = <span class="xml"><span class="tag">&lt;<span class="name">TFunction</span> <span class="attr">extends</span> <span class="attr">Function</span>&gt;</span>(target: TFunction) =&gt; TFunction | void;</span></span><br></pre></td></tr></table></figure>

<p><code>class</code> 装饰器应用于类的构造器，可用于观测、修改、替换类定义。</p>
<p>类装饰器只有一个参数: <code>constructor</code>，<code>constructor</code>为类的构造函数。<strong>类装饰器的返回值可以为空，也可以是一个新的构造函数</strong>。</p>
<h4 id="扩展构造函数"><a href="#扩展构造函数" class="headerlink" title="扩展构造函数"></a>扩展构造函数</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@name</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">sayHi</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`My name is: <span class="subst">$&#123;<span class="built_in">this</span>.name&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个继承自Person的匿名类</span></span><br><span class="line"><span class="comment">// 直接返回并替换原有的构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params">constructor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">constructor</span> </span>&#123;</span><br><span class="line">    name = <span class="string">&#x27;Niko&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Person().sayHi()</span><br></pre></td></tr></table></figure>

<h4 id="修改原有属性的描述符"><a href="#修改原有属性的描述符" class="headerlink" title="修改原有属性的描述符"></a>修改原有属性的描述符</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@seal</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">sayHi</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">seal</span>(<span class="params">constructor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(<span class="title">constructor</span>.<span class="title">prototype</span>, &#x27;<span class="title">sayHi</span>&#x27;)</span><br><span class="line">  <span class="title">Object</span>.<span class="title">defineProperty</span>(<span class="params">constructor.prototype, <span class="string">&#x27;sayHi&#x27;</span>, &#123;</span></span><br><span class="line"><span class="params">    ...descriptor,</span></span><br><span class="line"><span class="params">    writable: <span class="literal">false</span></span></span><br><span class="line"><span class="params">  &#125;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">Person</span>.<span class="title">prototype</span>.<span class="title">sayHi</span> = 1 // 无效</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="使用闭包来增强装饰器的功能"><a href="#使用闭包来增强装饰器的功能" class="headerlink" title="使用闭包来增强装饰器的功能"></a>使用闭包来增强装饰器的功能</h4><p>因为<code>@</code>符号后边跟的是一个函数的引用，所以对于mixin的实现，我们可以很轻易的使用闭包来实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123; <span class="function"><span class="title">say</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> <span class="number">1</span> &#125; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123; <span class="function"><span class="title">hi</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> <span class="number">2</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@mixin</span>(A, B)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mixin</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用函数返回装饰器实际应用的函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">constructor</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> arg <span class="keyword">of</span> args) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(arg.prototype)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;constructor&#x27;</span>) <span class="keyword">continue</span> <span class="comment">// 跳过构造函数</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(<span class="title">constructor</span>.<span class="title">prototype</span>, <span class="title">key</span>, <span class="title">Object</span>.<span class="title">getOwnPropertyDescriptor</span>(<span class="params">arg.prototype, key</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">let</span> <span class="title">c</span> = <span class="title">new</span> <span class="title">C</span>(<span class="params"></span>)</span><br><span class="line"><span class="title">console</span>.<span class="title">log</span>(<span class="params">c.say(), c.hi()</span>) // 1, 2</span><br></pre></td></tr></table></figure>

<h4 id="覆盖旧的构造函数"><a href="#覆盖旧的构造函数" class="headerlink" title="覆盖旧的构造函数"></a>覆盖旧的构造函数</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">classDecorator</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123; <span class="keyword">new</span> (...args: <span class="built_in">any</span>[]): &#123;&#125; &#125;&gt;( <span class="title">constructor</span>: <span class="title">T</span>) &#123;</span><br><span class="line"> 	<span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">constructor</span> </span>&#123;</span><br><span class="line">    newProperty = <span class="string">&quot;new property&quot;</span>;</span><br><span class="line">    hello = <span class="string">&quot;override&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@classDecorator</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span></span>&#123;</span><br><span class="line">	property = <span class="string">&quot;property&quot;</span>;</span><br><span class="line"></span><br><span class="line">	hello: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">m: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.hello = m;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> greeter: Greeter = <span class="keyword">new</span> Greeter(<span class="string">&quot;world&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(&#123; greeter &#125;, greeter.hello);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> &#123;</span></span><br><span class="line"><span class="comment">  &quot;greeter&quot;: &#123;</span></span><br><span class="line"><span class="comment">    &quot;property&quot;: &quot;property&quot;,</span></span><br><span class="line"><span class="comment">    &quot;hello&quot;: &quot;override&quot;,</span></span><br><span class="line"><span class="comment">    &quot;newProperty&quot;: &quot;new property&quot;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;,  &quot;override&quot; </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h4 id="多个装饰器的应用"><a href="#多个装饰器的应用" class="headerlink" title="多个装饰器的应用"></a>多个装饰器的应用</h4><p>可以多个装饰器一起使用：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@decorator1</span></span><br><span class="line"><span class="meta">@decorator2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>执行的顺序为<code>decorator2</code> -&gt; <code>decorator1</code>，离<code>class</code>定义最近的先执行。</p>
<h3 id="Method-装饰器"><a href="#Method-装饰器" class="headerlink" title="Method 装饰器"></a>Method 装饰器</h3><p>方法装饰器的类型定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MethodDecorator = &lt;T&gt;<span class="function">(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, descriptor: TypedPropertyDescriptor&lt;T&gt;</span>) =&gt;</span> TypedPropertyDescriptor&lt;T&gt; | <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<p>方法装饰器有 3 个参数 target 、 propertyKey 和 descriptor。</p>
<ul>
<li><strong>target</strong>： <strong>静态方法是类的构造函数，实例方法是类的原型对象</strong></li>
<li><strong>propertyKey</strong>： 方法名</li>
<li><strong>descriptor</strong>： 属性描述符 方法装饰器的返回值可以为空，也可以是一个新的属性描述符。</li>
</ul>
<p>函数装饰是如果有返回值会默认作为属性的<code>value</code>描述符存在，如果返回值为<code>undefined</code>则会忽略，使用之前的<code>descriptor</code>引用作为函数的描述符。</p>
<h4 id="方案一-修改现有描述符"><a href="#方案一-修改现有描述符" class="headerlink" title="方案一 修改现有描述符"></a>方案一 修改现有描述符</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Log: MethodDecorator = <span class="function">(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> className = target.constructor.name;</span><br><span class="line">    <span class="keyword">const</span> oldValue = descriptor.value;</span><br><span class="line">    descriptor.value = <span class="function"><span class="keyword">function</span>(<span class="params">...params</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`调用<span class="subst">$&#123;className&#125;</span>.<span class="subst">$&#123;key&#125;</span>()方法`</span>);</span><br><span class="line">        <span class="keyword">return</span> oldValue.apply(<span class="built_in">this</span>, params);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Log</span></span><br><span class="line">    getName (): <span class="built_in">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tom&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entity = <span class="keyword">new</span> MyClass(<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> name = entity.getName();</span><br><span class="line"><span class="comment">// 输出: 调用MyClass.getName()方法</span></span><br></pre></td></tr></table></figure>

<p><strong>@Log 是一个方法装饰器</strong> ，使用时添加到方法声明前，用于自动输出方法的调用日志。方法装饰器的第 3 个参数是属性描述符，属性描述符的 value 表示方法的执行函数，用一个新的函数替换了原来值，新的方法还会调用原方法，只是在调用原方法前输出了一个日志。</p>
<h4 id="方案二-返回新的value描述符"><a href="#方案二-返回新的value描述符" class="headerlink" title="方案二 返回新的value描述符"></a>方案二 返回新的value描述符</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Log: MethodDecorator = <span class="function">(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> className = target.constructor.name;</span><br><span class="line">    <span class="keyword">const</span> oldValue = descriptor.value;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...descriptor,</span><br><span class="line">    <span class="function"><span class="title">value</span>(<span class="params">...args</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`调用<span class="subst">$&#123;className&#125;</span>.<span class="subst">$&#123;key&#125;</span>()方法`</span>);</span><br><span class="line">        <span class="keyword">return</span> oldValue.apply(<span class="built_in">this</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Log</span></span><br><span class="line">    getName (): <span class="built_in">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Tom&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entity = <span class="keyword">new</span> MyClass(<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> name = entity.getName();</span><br></pre></td></tr></table></figure>



<h3 id="Property-装饰器"><a href="#Property-装饰器" class="headerlink" title="Property 装饰器"></a>Property 装饰器</h3><p>属性装饰器的类型定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PropertyDecorator = <span class="function">(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol</span>) =&gt;</span> <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<p>属性装饰器有两个参数 target 和 propertyKey。</p>
<ul>
<li><strong>target</strong>：<strong>静态属性是类的构造函数，实例属性是类的原型对象</strong></li>
<li><strong>propertyKey</strong>：属性名</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> CheckRule &#123;</span><br><span class="line">    <span class="attr">required</span>: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> MetaData &#123;</span><br><span class="line">    [key: <span class="built_in">string</span>]: CheckRule;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Required: PropertyDecorator = <span class="function">(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    target.__metadata = target.__metadata ? target.__metadata : &#123;&#125;;</span><br><span class="line">    target.__metadata[key] = &#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Required</span></span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Required</span></span><br><span class="line">    <span class="attr">type</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>@Required 是一个属性装饰器，使用时添加到属性声明前，作用是在 target 的自定义属性 metadata 中添加对应属性的必填规则</strong>。</p>
<p>上例添加装饰器后 <code>target.metadata</code> 的值为：<code>&#123; name: &#123; required: true &#125;, type: &#123; required: true &#125; &#125;</code>。通过读取 <code>__metadata </code>可以获得设置的必填的属性，从而对实例对象进行校验，校验相关的代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">entity</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> metadata: MetaData = entity.__metadata;</span><br><span class="line">    <span class="keyword">if</span>(metadata) &#123;</span><br><span class="line">        <span class="keyword">let</span> i: <span class="built_in">number</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="built_in">string</span>,</span><br><span class="line">            <span class="attr">rule</span>: CheckRule;</span><br><span class="line">        <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(metadata);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">            key = keys[i];</span><br><span class="line">            rule = metadata[key];</span><br><span class="line">            <span class="keyword">if</span> (rule.required &amp;&amp; (entity[key] === <span class="literal">undefined</span> || entity[key] === <span class="literal">null</span> || entity[key] === <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entity: MyClass = <span class="keyword">new</span> MyClass();</span><br><span class="line">entity.name = <span class="string">&#x27;name&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> result: <span class="built_in">boolean</span> = validate(entity);</span><br><span class="line"><span class="built_in">console</span>.log(result); <span class="comment">// 输出结果：false</span></span><br></pre></td></tr></table></figure>



<h3 id="Parameter-装饰器"><a href="#Parameter-装饰器" class="headerlink" title="Parameter 装饰器"></a>Parameter 装饰器</h3><p>参数装饰器的类型定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ParameterDecorator = <span class="function">(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, parameterIndex: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<p>参数装饰器有 3 个参数 target 、 propertyKey 和 descriptor。</p>
<ul>
<li><strong>target</strong>：<strong>静态方法的参数是类的构造函数，实例方法的参数是类的原型对象</strong></li>
<li><strong>propertyKey</strong>：参数所在方法的方法名</li>
<li><strong>parameterIndex</strong>：在方法参数列表中的索引值</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parseConf = &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modal</span> </span>&#123;</span><br><span class="line">  <span class="meta">@parseFunc</span></span><br><span class="line">  <span class="function"><span class="title">addOne</span>(<span class="params"><span class="meta">@parse</span>(<span class="string">&#x27;number&#x27;</span>) num</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> num + <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在函数调用前执行格式化操作</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseFunc</span> (<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...descriptor,</span><br><span class="line">    value (...arg) &#123;</span><br><span class="line">      <span class="comment">// 获取格式化配置</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> [index, <span class="keyword">type</span>] <span class="keyword">of</span> parseConf) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;number&#x27;</span>:  arg[index] = <span class="built_in">Number</span>(arg[index])             <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;string&#x27;</span>:  arg[index] = <span class="built_in">String</span>(arg[index])             <span class="keyword">break</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;boolean&#x27;</span>: arg[index] = <span class="built_in">String</span>(arg[index]) === <span class="string">&#x27;true&#x27;</span>  <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> descriptor.value.apply(<span class="built_in">this</span>, arg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向全局对象中添加对应的格式化信息</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params"><span class="keyword">type</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, name, index</span>) </span>&#123;</span><br><span class="line">    parseConf[index] = <span class="keyword">type</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> Modal().addOne(<span class="string">&#x27;10&#x27;</span>)) <span class="comment">// 11</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结合着函数装饰器来完成对函数参数的类型转换</p>
<h3 id="访问符装饰器"><a href="#访问符装饰器" class="headerlink" title="访问符装饰器"></a>访问符装饰器</h3><p>访问符装饰器类型定义和 方法装饰器类型定义一样：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MethodDecorator = &lt;T&gt;<span class="function">(<span class="params">target: <span class="built_in">Object</span>, propertyKey: <span class="built_in">string</span> | symbol, descriptor: TypedPropertyDescriptor&lt;T&gt;</span>) =&gt;</span> TypedPropertyDescriptor&lt;T&gt; | <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<p>访问符装饰器的使用与方法装饰器一致，参数和返回值相同，只是访问符装饰器用在访问符声明之前。 <strong>需要注意的是，TypeScript 不允许同时装饰一个成员的 get 和 set 访问符。</strong> </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Enumerable: MethodDecorator = <span class="function">(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) =&gt;</span> &#123;</span><br><span class="line">    descriptor.enumerable = <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="attr">createDate</span>: <span class="built_in">Date</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Enumerable</span></span><br><span class="line">    get createTime () &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.createDate.getTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> entity = <span class="keyword">new</span> MyClass();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> entity) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`entity.<span class="subst">$&#123;key&#125;</span> =`</span>, entity[key]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 输出：</span></span><br><span class="line"><span class="comment">entity.createDate = 2020-04-08T10:40:51.133Z</span></span><br><span class="line"><span class="comment">entity.createTime = 1586342451133</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><strong>MyClass 类中有一个属性 createDate 为 Date 类型</strong>， 另外增加一个有 get 声明的 createTime 方法，就可以以 entity.createTime 方式获得 createDate 的毫秒值。 <strong>但是 createTime 默认是不可枚举的，通过在声明前增加 @Enumerable 装饰器可以使 createTime 成为可枚举的属性。</strong></p>
<p>给属性设置前缀</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modal</span> </span>&#123;</span><br><span class="line">  _name = <span class="string">&#x27;Niko&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@prefix</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title">name</span>() &#123; <span class="keyword">return</span> <span class="built_in">this</span>._name &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prefix</span>(<span class="params">target, name, descriptor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...descriptor,</span><br><span class="line">    get () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`wrap_<span class="subst">$&#123;<span class="built_in">this</span>._name&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> Modal().name) <span class="comment">// wrap_Niko</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="静态类型和实例类型"><a href="#静态类型和实例类型" class="headerlink" title="静态类型和实例类型"></a>静态类型和实例类型</h3><p>默认Typescript属性是无法获取到的 <code>descriptor</code>,但 静态属性是可以手动拿到的，但实例属性不行。</p>
<h5 id="什么是静态属性和实例属性"><a href="#什么是静态属性和实例属性" class="headerlink" title="什么是静态属性和实例属性"></a>什么是静态属性和实例属性</h5><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 实例成员</span></span><br><span class="line">  method1 () &#123;&#125; <span class="comment">// 实例方法</span></span><br><span class="line">  method2 = <span class="function">() =&gt;</span> &#123;&#125; <span class="comment">//实例属性</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态成员</span></span><br><span class="line">  <span class="keyword">static</span> method3 () &#123;&#125; <span class="comment">// 静态方法</span></span><br><span class="line">  <span class="keyword">static</span> method4 = <span class="function">() =&gt;</span> &#123;&#125; <span class="comment">// 静态属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>method1</code>和<code>method2</code>是实例成员，<code>method1</code>存在于<code>prototype</code>之上，而<code>method2</code>只在实例化对象以后才有。<br> 作为静态成员的<code>method3</code>和<code>method4</code>，两者的区别在于是否可枚举描述符的设置，所以可以简单地认为，上述代码转换为ES5版本后是这样子的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Model</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 成员仅在实例化时赋值</span></span><br><span class="line">  <span class="built_in">this</span>.method2 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员被定义在原型链上</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Model.prototype, <span class="string">&#x27;method1&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;, </span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">false</span>,  <span class="comment">// 设置不可被枚举</span></span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员被定义在构造函数上，且是默认的可被枚举</span></span><br><span class="line">Model.method4 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员被定义在构造函数上</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Model, <span class="string">&#x27;method3&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;, </span><br><span class="line">  <span class="attr">writable</span>: <span class="literal">true</span>, </span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">false</span>,  <span class="comment">// 设置不可被枚举</span></span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看出，只有<code>method2</code>是在实例化时才赋值的，一个不存在的属性是不会有<code>descriptor</code>的，所以这就是为什么TS在针对<code>Property Decorator</code>不传递第三个参数的原因，至于为什么静态成员也没有传递<code>descriptor</code>.</p>
<p>就像上述的示例，我们针对四个成员都添加了装饰器以后，<code>method1</code>和<code>method2</code>第一个参数就是<code>Model.prototype</code>，而<code>method3</code>和<code>method4</code>的第一个参数就是<code>Model</code>。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 实例成员</span></span><br><span class="line">  <span class="meta">@instance</span></span><br><span class="line">  method1 () &#123;&#125;</span><br><span class="line">  <span class="meta">@instance</span></span><br><span class="line">  method2 = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态成员</span></span><br><span class="line">  <span class="meta">@static</span></span><br><span class="line">  <span class="keyword">static</span> method3 () &#123;&#125;</span><br><span class="line">  <span class="meta">@static</span></span><br><span class="line">  <span class="keyword">static</span> method4 = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">instance</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(target.constructor === Model)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">static</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(target === Model)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="静态属性手动获取-descriptor"><a href="#静态属性手动获取-descriptor" class="headerlink" title="静态属性手动获取 descriptor"></a>静态属性手动获取 descriptor</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modal</span> </span>&#123;</span><br><span class="line">  <span class="meta">@prefix</span></span><br><span class="line">  <span class="keyword">static</span> name1 = <span class="string">&#x27;Niko&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prefix</span>(<span class="params">target, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, name)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, name, &#123;</span><br><span class="line">    ...descriptor,</span><br><span class="line">    <span class="attr">value</span>: <span class="string">`wrap_<span class="subst">$&#123;descriptor.value&#125;</span>`</span></span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Modal.name1) <span class="comment">// wrap_Niko</span></span><br></pre></td></tr></table></figure>



<h2 id="装饰器执行顺序"><a href="#装饰器执行顺序" class="headerlink" title="装饰器执行顺序"></a>装饰器执行顺序</h2><p>不同声明上的装饰器将按以下顺序执行：</p>
<ol>
<li><strong>实例成员的装饰器</strong>：参数装饰器 &gt; 方法装饰器 &gt; 访问符装饰器/属性装饰器</li>
<li><strong>静态成员的装饰器</strong>：参数装饰器 &gt; 方法装饰器 &gt; 访问符装饰器/属性装饰器</li>
<li><strong>构造函数的参数装饰器</strong></li>
<li><strong>类装饰器</strong></li>
</ol>
<p>如果同一个声明有多个装饰器，离声明越近的装饰器越早执行：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClass1</span>(<span class="params">params:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;类装饰器1&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClass2</span>(<span class="params">params:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;类装饰器2&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logAttribute1</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;属性装饰器1&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logAttribute2</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;属性装饰器2&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logMethod1</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span>,desc:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;方法装饰器1&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logMethod2</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span>,desc:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;方法装饰器2&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logParams1</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span>,desc:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;方法参数装饰器1&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logParams2</span>(<span class="params">params?:<span class="built_in">string</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">target:<span class="built_in">any</span>,attrName:<span class="built_in">any</span>,desc:<span class="built_in">any</span></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;方法参数装饰器2&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logClass1</span>(<span class="string">&#x27;http://www.loaderman.com/api&#x27;</span>)</span><br><span class="line"><span class="meta">@logClass2</span>(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpClient</span></span>&#123;</span><br><span class="line">    <span class="meta">@logAttribute1</span>()</span><br><span class="line">    <span class="meta">@logAttribute2</span>()</span><br><span class="line">    <span class="keyword">public</span> apiUrl:<span class="built_in">string</span> | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@logMethod1</span>()</span><br><span class="line">    <span class="meta">@logMethod2</span>()</span><br><span class="line">    <span class="function"><span class="title">getData</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">setData</span>(<span class="params"><span class="meta">@logParams1</span>() attr1:<span class="built_in">any</span>,<span class="meta">@logParams2</span>() attr2:<span class="built_in">any</span>,</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> http:<span class="built_in">any</span>=<span class="keyword">new</span> HttpClient();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">[LOG]: &quot;属性装饰器2&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;属性装饰器1&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;方法装饰器2&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;方法装饰器1&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;方法参数装饰器2&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;方法参数装饰器1&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;类装饰器2&quot; </span></span><br><span class="line"><span class="comment">[LOG]: &quot;类装饰器1&quot; </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;f(): evaluated&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;f(): called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;g(): evaluated&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">target, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;g(): called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="meta">@f</span>()</span><br><span class="line">    <span class="meta">@g</span>()</span><br><span class="line">    <span class="function"><span class="title">method</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f(): evaluated</span><br><span class="line">g(): evaluated</span><br><span class="line">g(): called</span><br><span class="line">f(): called</span><br></pre></td></tr></table></figure>



<h2 id="装饰工厂🏭"><a href="#装饰工厂🏭" class="headerlink" title="装饰工厂🏭"></a>装饰工厂🏭</h2><p>由于每种装饰器都有它自身的调用签名，我们可以使用装饰器工厂来泛化装饰器调用。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; logClass &#125; <span class="keyword">from</span> <span class="string">&#x27;./class-decorator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; logMethod &#125; <span class="keyword">from</span> <span class="string">&#x27;./method-decorator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; logProperty &#125; <span class="keyword">from</span> <span class="string">&#x27;./property-decorator&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; logParameter &#125; <span class="keyword">from</span> <span class="string">&#x27;./parameter-decorator&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器工厂，根据传入的参数调用相应的装饰器</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (args.length) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// 可能是方法装饰器或参数装饰器</span></span><br><span class="line">            <span class="comment">// 如果第三个参数是数字，那么它是索引，所以这是参数装饰器</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">typeof</span> args[<span class="number">2</span>] === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> logParameter.apply(<span class="built_in">this</span>, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> logMethod.apply(<span class="built_in">this</span>, args);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// 属性装饰器 </span></span><br><span class="line">            <span class="keyword">return</span> logProperty.apply(<span class="built_in">this</span>, args);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// 类装饰器</span></span><br><span class="line">            <span class="keyword">return</span> logClass.apply(<span class="built_in">this</span>, args);</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 参数数目不合法</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Not a valid decorator&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    <span class="meta">@log</span></span><br><span class="line">    <span class="keyword">private</span> name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@log</span></span><br><span class="line">    greet(<span class="meta">@log</span> message: <span class="built_in">string</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.name&#125;</span> says: <span class="subst">$&#123;message&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="装饰器的应用"><a href="#装饰器的应用" class="headerlink" title="装饰器的应用"></a>装饰器的应用</h2><p>使用装饰器可以实现自动注册路由，通过给 Controller 层的类和方法添加装饰器来定义路由信息，当创建路由时扫描指定目录下所有 Controller，获取装饰器定义的路由信息，从而实现自动添加路由。</p>
<h3 id="装饰器代码"><a href="#装饰器代码" class="headerlink" title="装饰器代码"></a>装饰器代码</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/common/decorator/controller.ts */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Route &#123;</span><br><span class="line">    <span class="attr">propertyKey</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="built_in">string</span>;</span><br><span class="line">    path: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Controller</span>(<span class="params">path: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span></span>): <span class="title">ClassDecorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">target: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">Reflect</span>.defineMetadata(<span class="string">&#x27;basePath&#x27;</span>, path, target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RouterDecoratorFactory = <span class="function">(<span class="params">path?: <span class="built_in">string</span></span>) =&gt;</span> MethodDecorator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouterDecorator</span>(<span class="params">method: <span class="built_in">string</span></span>): <span class="title">RouterDecoratorFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">path?: <span class="built_in">string</span></span>) =&gt;</span> <span class="function">(<span class="params">target: <span class="built_in">any</span>, propertyKey: <span class="built_in">string</span>, descriptor: PropertyDescriptor</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> route: Route = &#123;</span><br><span class="line">            propertyKey,</span><br><span class="line">            method,</span><br><span class="line">            <span class="attr">path</span>: path || <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">Reflect</span>.hasMetadata(<span class="string">&#x27;routes&#x27;</span>, target)) &#123;</span><br><span class="line">            <span class="built_in">Reflect</span>.defineMetadata(<span class="string">&#x27;routes&#x27;</span>, [], target);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> routes = <span class="built_in">Reflect</span>.getMetadata(<span class="string">&#x27;routes&#x27;</span>, target);</span><br><span class="line">        routes.push(route);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Get: RouterDecoratorFactory = createRouterDecorator(<span class="string">&#x27;get&#x27;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Post: RouterDecoratorFactory = createRouterDecorator(<span class="string">&#x27;post&#x27;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Put: RouterDecoratorFactory = createRouterDecorator(<span class="string">&#x27;put&#x27;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Delete: RouterDecoratorFactory = createRouterDecorator(<span class="string">&#x27;delete&#x27;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Patch: RouterDecoratorFactory = createRouterDecorator(<span class="string">&#x27;patch&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="控制器代码"><a href="#控制器代码" class="headerlink" title="控制器代码"></a>控制器代码</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/controller/roleController.ts */</span></span><br><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">&#x27;koa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get &#125; <span class="keyword">from</span> <span class="string">&#x27;../common/decorator/controller&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> RoleService <span class="keyword">from</span> <span class="string">&#x27;../service/roleService&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;/roles&#x27;</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> getRoles (ctx: Koa.Context) &#123;</span><br><span class="line">        <span class="keyword">const</span> roles = <span class="keyword">await</span> RoleService.findRoles();</span><br><span class="line">        ctx.body = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;/roles/:id&#x27;</span>)</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> getRoleById (ctx: Koa.Context) &#123;</span><br><span class="line">        <span class="keyword">const</span> id = ctx.params.id;</span><br><span class="line">        <span class="keyword">const</span> role = <span class="keyword">await</span> RoleService.findRoleById(id);</span><br><span class="line">        ctx.body = role;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由器代码"><a href="#路由器代码" class="headerlink" title="路由器代码"></a>路由器代码</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/common /scanRouter.ts */</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> KoaRouter <span class="keyword">from</span> <span class="string">&#x27;koa-router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Route &#125; <span class="keyword">from</span> <span class="string">&#x27;./decorator/controller&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描指定目录的Controller并添加路由</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scanController</span>(<span class="params">dirPath: <span class="built_in">string</span>, router: KoaRouter</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!fs.existsSync(dirPath)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">`目录不存在！<span class="subst">$&#123;dirPath&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> fileNames: <span class="built_in">string</span>[] = fs.readdirSync(dirPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">of</span> fileNames) &#123;</span><br><span class="line">        <span class="keyword">const</span> curPath: <span class="built_in">string</span> = path.join(dirPath, name);</span><br><span class="line">        <span class="keyword">if</span> (fs.statSync(curPath).isDirectory()) &#123;</span><br><span class="line">            scanController(curPath, router);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="regexp">/(.js|.jsx|.ts|.tsx)$/</span>.test(name))) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> scannedModule = <span class="built_in">require</span>(curPath);</span><br><span class="line">            <span class="keyword">const</span> controller = scannedModule.default || scannedModule;</span><br><span class="line">            <span class="keyword">const</span> isController: <span class="built_in">boolean</span> = <span class="built_in">Reflect</span>.hasMetadata(<span class="string">&#x27;basePath&#x27;</span>, controller);</span><br><span class="line">            <span class="keyword">const</span> hasRoutes: <span class="built_in">boolean</span> = <span class="built_in">Reflect</span>.hasMetadata(<span class="string">&#x27;routes&#x27;</span>, controller);</span><br><span class="line">            <span class="keyword">if</span> (isController &amp;&amp; hasRoutes) &#123;</span><br><span class="line">                <span class="keyword">const</span> basePath: <span class="built_in">string</span> = <span class="built_in">Reflect</span>.getMetadata(<span class="string">&#x27;basePath&#x27;</span>, controller);</span><br><span class="line">                <span class="keyword">const</span> routes: Route[] = <span class="built_in">Reflect</span>.getMetadata(<span class="string">&#x27;routes&#x27;</span>, controller);</span><br><span class="line">                <span class="keyword">let</span> curPath: <span class="built_in">string</span>, curRouteHandler;</span><br><span class="line">                routes.forEach( <span class="function">(<span class="params">route: Route</span>) =&gt;</span> &#123;</span><br><span class="line">                    curPath = path.posix.join(<span class="string">&#x27;/&#x27;</span>, basePath, route.path);</span><br><span class="line">                    curRouteHandler = controller[route.propertyKey];</span><br><span class="line">                    router[route.method](curPath, curRouteHandler);</span><br><span class="line">                    <span class="built_in">console</span>.info(<span class="string">`router: <span class="subst">$&#123;controller.name&#125;</span>.<span class="subst">$&#123;route.propertyKey&#125;</span> [<span class="subst">$&#123;route.method&#125;</span>] <span class="subst">$&#123;curPath&#125;</span>`</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&#x27;文件读取失败！&#x27;</span>, curPath, error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ScanRouter</span> <span class="keyword">extends</span> <span class="title">KoaRouter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">opt?: KoaRouter.IRouterOptions</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(opt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    scan (scanDir: <span class="built_in">string</span> | <span class="built_in">string</span>[]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> scanDir === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">            scanController(scanDir, <span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scanDir <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">            scanDir.forEach(<span class="keyword">async</span> (dir: <span class="built_in">string</span>) =&gt; &#123;</span><br><span class="line">                scanController(dir, <span class="built_in">this</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建路由代码"><a href="#创建路由代码" class="headerlink" title="创建路由代码"></a>创建路由代码</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/router.ts */</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ScanRouter <span class="keyword">from</span> <span class="string">&#x27;./common/scanRouter&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> ScanRouter();</span><br><span class="line"></span><br><span class="line">router.scan([path.resolve(__dirname, <span class="string">&#x27;./controller&#x27;</span>)]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>





<h2 id="Refer-To"><a href="#Refer-To" class="headerlink" title="Refer To"></a>Refer To</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903635168526343#heading-15">https://juejin.cn/post/6844903635168526343#heading-15</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/ikvkdvq9haopv5yfppmj">https://www.infoq.cn/article/ikvkdvq9haopv5yfppmj</a></p>
<p><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/decorators.html">https://www.typescriptlang.org/docs/handbook/decorators.html</a></p>
<p><a target="_blank" rel="noopener" href="https://yrq110.me/post/front-end/typescript-decorator-practice/">https://yrq110.me/post/front-end/typescript-decorator-practice/</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://fynn90.github.io">Fynn</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://fynn90.github.io/2021/01/15/TS%E8%A3%85%E9%A5%B0%E5%99%A8/">https://fynn90.github.io/2021/01/15/TS%E8%A3%85%E9%A5%B0%E5%99%A8/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
  <div class="post-reward">
    <input type="checkbox" name="reward" id="reward" hidden />
    <label class="reward-button" for="reward">赞赏支持</label>
    <div class="qr-code">
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/wechat.png" title="wechat">
        </label>
      
      
        <label class="qr-code-image" for="reward">
          <img class="image" src="/image/reward/alipay.png" title="alipay">
        </label>
      
    </div>
  </div>

    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/decorator/">decorator</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2021/01/16/ReflectMetadata/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">ReflectMetadata</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2021/01/05/Java%20%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6(Collections)/">
        <span class="next-text nav-default">Java collections framework</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:fynn.90@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
        
          <a target="_blank" rel="noopener" href="https://www.linkedin.com/in/%E5%B8%86-%E9%82%93-17163589/" class="iconfont icon-linkedin" title="linkedin"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="https://github.com/fynn90" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="http://www.weibo.com/306019091" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
        
          <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/FynnDeng/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2021

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Fynn</span>
  </span>
  
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
